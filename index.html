<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KryptonPath Dialogue Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        :root {
            --krypton-indigo: #4c51bf; /* Indigo 600 - Primary */
            --krypton-dark: #1f2937; /* Gray 800 - Background */
            --krypton-card: #374151; /* Gray 700 - Card */
            --krypton-text: #f3f4f6; /* Gray 100 - Text */
            --krypton-accent: #fcd34d; /* Amber 300 - Accent/Credit */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--krypton-dark);
            color: var(--krypton-text);
        }
        .container-card {
            background-color: var(--krypton-card);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        .input-style {
            background-color: var(--krypton-dark);
            border: 2px solid #4b5563;
            color: var(--krypton-text);
        }
        .button-primary {
            background-color: var(--krypton-indigo);
            transition: background-color 0.3s, transform 0.1s;
        }
        .button-primary:hover {
            background-color: #6366f1;
            transform: translateY(-1px);
        }
        .a11y-focus-ring:focus {
            outline: 3px solid var(--krypton-accent);
            outline-offset: 2px;
        }
        .loading-dot {
            animation: dot-flicker 1.5s infinite ease-in-out;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.5s; }
        .loading-dot:nth-child(3) { animation-delay: 1s; }
        @keyframes dot-flicker {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.75);
        }
    </style>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Globals ---
        const API_KEY = ""; // Provided by the environment
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'dialogue-designer';
        const FIREBASE_CONFIG = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db = null;
        let auth = null;
        let userId = null;
        let credits = 0;
        const INITIAL_CREDITS = 3;

        // --- DOM Elements ---
        const resultsDiv = document.getElementById('results-area');
        const loaderDiv = document.getElementById('loading-indicator');
        const submitButton = document.getElementById('submit-btn');
        const creditCounter = document.getElementById('credit-counter');
        const purchaseModal = document.getElementById('purchase-modal');
        const closeModalButton = document.getElementById('close-modal-btn');
        const buyScriptsButton = document.getElementById('buy-scripts-btn');
        const form = document.getElementById('dialogue-form');

        // --- Event Listeners ---
        closeModalButton.addEventListener('click', () => purchaseModal.classList.add('hidden'));
        buyScriptsButton.addEventListener('click', mockPurchase);
        form.addEventListener('submit', handleFormSubmit);

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            if (!FIREBASE_CONFIG) {
                console.error("Firebase config is missing. Cannot initialize database.");
                return;
            }

            const app = initializeApp(FIREBASE_CONFIG);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); // Set log level for debugging

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Authenticated with UID:", userId);
                    await loadCredits();
                } else {
                    if (INITIAL_AUTH_TOKEN) {
                        try {
                            await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                        } catch (error) {
                            console.error("Custom token sign-in failed:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        }

        /**
         * Loads user credits from Firestore, setting default if new user.
         */
        async function loadCredits() {
            if (!db || !userId) return;

            // Path: /artifacts/{appId}/users/{userId}/usage_credits/dialogue_app
            const creditRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'usage_credits', 'dialogue_app');

            try {
                const docSnap = await getDoc(creditRef);
                if (docSnap.exists()) {
                    credits = docSnap.data().count || 0;
                } else {
                    // New user: grant initial credits
                    credits = INITIAL_CREDITS;
                    await setDoc(creditRef, { count: credits, userId: userId, lastUpdated: new Date().toISOString() });
                }
            } catch (e) {
                console.error("Error loading credits:", e);
                // Fallback: If Firestore fails, assume full credits to allow use
                credits = INITIAL_CREDITS;
            }
            updateCreditUI();
        }

        /**
         * Checks if credits exist, decrements them, and saves to Firestore.
         * @returns {Promise<boolean>} True if generation is allowed and decremented.
         */
        async function checkAndDecrementCredits() {
            if (credits <= 0) {
                return false;
            }

            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return true; // Fail-safe: allow if environment error prevents tracking
            }

            try {
                const newCount = credits - 1;
                const creditRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'usage_credits', 'dialogue_app');
                await setDoc(creditRef, { count: newCount, userId: userId, lastUpdated: new Date().toISOString() }, { merge: false });
                credits = newCount;
                updateCreditUI();
                return true;
            } catch (e) {
                console.error("Error decrementing credits:", e);
                // Fail-safe: Allow the use, but credits might be incorrect
                credits--; 
                updateCreditUI();
                return true;
            }
        }

        /**
         * Updates the UI to show the current credit count and button state.
         */
        function updateCreditUI() {
            creditCounter.textContent = `${credits} Script Credits`;
            if (credits <= 0) {
                submitButton.disabled = true;
                submitButton.textContent = 'Out of Credits';
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                submitButton.classList.remove('hover:bg-indigo-500');
            } else {
                submitButton.disabled = false;
                submitButton.textContent = 'Generate Scripts (1 Credit)';
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                submitButton.classList.add('hover:bg-indigo-500');
            }
        }

        /**
         * Handles the form submission event (Check credits, generate, decrement).
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            resultsDiv.innerHTML = '';
            resultsDiv.classList.add('hidden');
            
            if (credits <= 0) {
                purchaseModal.classList.remove('hidden');
                return;
            }

            const formData = new FormData(form);
            const situation = formData.get('situation');
            const role = formData.get('role');
            const context = formData.get('context');
            
            if (!situation || !role || !context) {
                resultsDiv.innerHTML = '<p class="text-red-400 p-4" role="alert">Please fill out all fields.</p>';
                resultsDiv.classList.remove('hidden');
                return;
            }

            // Show loading state and disable button
            loaderDiv.classList.remove('hidden');
            submitButton.disabled = true;
            submitButton.textContent = 'Generating...';

            try {
                const isAllowed = await checkAndDecrementCredits();
                if (!isAllowed) {
                    purchaseModal.classList.remove('hidden');
                    return;
                }

                const { text, sources } = await generateScripts(situation, role, context);
                displayResults(text, sources);
                
            } catch (error) {
                console.error("Generation error:", error);
                resultsDiv.innerHTML = '<p class="text-red-400 p-4" role="alert">An error occurred while generating scripts. Please try again. (Check console for details.)</p>';
                resultsDiv.classList.remove('hidden');
            } finally {
                // Hide loading state
                loaderDiv.classList.add('hidden');
                updateCreditUI(); 
            }
        }

        /**
         * The core function to call the Gemini API for script generation.
         */
        async function generateScripts(situation, role, context) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            const systemPrompt = `You are the KryptonPath Dialogue Designer. Your goal is to provide three distinct, professionally polished script options for sensitive workplace conversations. 
                The user has specified their situation and role.
                Your response MUST be structured using clear H2 titles for each script type: "## 1. Direct Script (Action-Oriented)", "## 2. Empathetic Script (Relationship-Focused)", and "## 3. Formal Script (Documentation-Ready)".
                Each script MUST be presented as a simple dialogue between the user and the 'Recipient'. Do not add any introductory or concluding text outside of the three scripts.`;

            const userQuery = `Generate three conversation scripts.
                - **Situation/Topic:** ${situation}
                - **My Role:** ${role}
                - **Brief Context:** ${context}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // Simplified fetch with exponential backoff omitted for brevity, but should be used in production.
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("API call failed.");
            
            const result = await response.json();
            const candidate = result.candidates?.[0];
            const text = candidate?.content?.parts?.[0]?.text || '';
            
            // Source extraction logic (optional for this specific API call, but included for completeness)
            let sources = [];
            return { text, sources };
        }

        /**
         * Displays the generated markdown results with proper formatting.
         */
        function displayResults(markdownText, sources) {
            // Simple markdown-to-HTML conversion for headings and paragraphs
            let html = markdownText.replace(/## (.*)/g, (match, title) => 
                `<h2 class="text-2xl font-bold text-yellow-400 mt-6 mb-3 border-b border-gray-600 pb-1">${title}</h2>`
            );
            html = html.replace(/\n/g, '<p class="mb-4">');

            let sourcesHtml = '';
            if (sources.length > 0) {
                 sourcesHtml = '<div class="mt-6 pt-4 border-t border-gray-600"><h4 class="font-semibold text-gray-400">Sources:</h4><ul class="text-sm list-disc pl-5 space-y-1">';
                 sources.forEach(source => {
                     sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="text-blue-400 hover:text-blue-300 underline a11y-focus-ring" aria-label="Source: ${source.title}">${source.title}</a></li>`;
                 });
                 sourcesHtml += '</ul></div>';
            }

            resultsDiv.innerHTML = `<div class="p-6 space-y-4">${html}${sourcesHtml}</div>`;
            resultsDiv.classList.remove('hidden');
            resultsDiv.setAttribute('aria-live', 'polite');
        }
        
        /**
         * Simulates the payment process and grants credits.
         */
        async function mockPurchase() {
            // In a live app, this would initiate a Razorpay checkout session.
            buyScriptsButton.disabled = true;
            buyScriptsButton.textContent = 'Processing...';

            // Simulate API call to Razorpay (2 second delay)
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // After successful payment (mocked), grant 10 credits
            const addedCredits = 10;
            const newCount = credits + addedCredits;

            try {
                const creditRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'usage_credits', 'dialogue_app');
                await setDoc(creditRef, { count: newCount, userId: userId, lastUpdated: new Date().toISOString() }, { merge: false });
                credits = newCount;
                
                // Success message
                alert('Purchase successful! 10 new credits added. You can now generate more scripts.');
                purchaseModal.classList.add('hidden');
                
            } catch (e) {
                console.error("Error granting credits after mock purchase:", e);
                alert('Payment simulated, but an error occurred updating your credits. Please contact support.');
            } finally {
                updateCreditUI();
                buyScriptsButton.disabled = false;
                buyScriptsButton.textContent = 'Buy 10 Scripts (â¹499)';
            }
        }

        window.onload = initializeFirebase;
    </script>
</head>
<body class="min-h-screen p-4 flex items-start justify-center">
    <main class="w-full max-w-4xl mt-8">
        <!-- Application Card -->
        <div class="container-card p-6 md:p-10 rounded-xl">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-2">
                    KryptonPath Dialogue Designer
                </h1>
                <p class="text-indigo-200">
                    Generate professional scripts for sensitive workplace conversations.
                </p>
                <div class="mt-4 p-2 bg-gray-600 rounded-lg inline-block">
                    <p class="text-sm font-semibold text-krypton-accent">
                        Current Credits: <span id="credit-counter">Loading...</span>
                    </p>
                </div>
            </header>

            <!-- Input Form -->
            <form id="dialogue-form" class="space-y-6">
                
                <!-- Situation Dropdown -->
                <div>
                    <label for="situation-select" class="block text-lg font-medium mb-2">
                        1. Select the situation/topic:
                    </label>
                    <select id="situation-select" name="situation" required class="input-style w-full p-3 rounded-lg a11y-focus-ring">
                        <option value="">-- Choose High-Stakes Conversation --</option>
                        <option value="Discussing subtle workplace bias/microaggressions">Discussing Bias/Microaggressions</option>
                        <option value="Requesting accommodations for a disability or neurodivergence">Requesting Accommodations</option>
                        <option value="Giving difficult performance feedback to a team member">Giving Difficult Feedback</option>
                        <option value="Negotiating a salary increase or promotion">Negotiating Salary/Promotion</option>
                        <option value="Challenging a decision made by a senior mentor or leader">Challenging a Leader's Decision</option>
                        <option value="Addressing inappropriate use of diversity labels">Addressing Inappropriate Language</option>
                    </select>
                </div>

                <!-- Role Dropdown -->
                <div>
                    <label for="role-select" class="block text-lg font-medium mb-2">
                        2. What is your role in this conversation?
                    </label>
                    <select id="role-select" name="role" required class="input-style w-full p-3 rounded-lg a11y-focus-ring">
                        <option value="">-- Select Your Position --</option>
                        <option value="Employee reporting to Manager">Employee (Report to Manager)</option>
                        <option value="Manager speaking to Direct Report">Manager (Speak to Direct Report)</option>
                        <option value="Peer/Colleague engaging a peer">Peer/Colleague</option>
                        <option value="Mentor speaking to Mentee">Mentor</option>
                    </select>
                </div>

                <!-- Context Input -->
                <div>
                    <label for="context-input" class="block text-lg font-medium mb-2">
                        3. Provide brief context (What happened? Who is involved?):
                    </label>
                    <textarea id="context-input" name="context" required placeholder="Example: My manager frequently interrupts me when I discuss project timelines, and it feels dismissive."
                           class="input-style w-full p-3 rounded-lg a11y-focus-ring h-32" 
                           aria-describedby="context-help"></textarea>
                    <p id="context-help" class="text-sm text-gray-400 mt-1">
                        Be specific for the most helpful scripts.
                    </p>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submit-btn" disabled 
                        class="button-primary w-full p-4 text-xl font-bold rounded-lg a11y-focus-ring opacity-50 cursor-not-allowed"
                        aria-live="polite">
                    Loading Credits...
                </button>
            </form>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden text-center mt-8 p-4" role="status" aria-label="Generating scripts, please wait.">
                <div class="flex items-center justify-center space-x-2">
                    <div class="w-3 h-3 bg-indigo-400 rounded-full loading-dot"></div>
                    <div class="w-3 h-3 bg-indigo-400 rounded-full loading-dot"></div>
                    <div class="w-3 h-3 bg-indigo-400 rounded-full loading-dot"></div>
                    <span class="ml-3 text-lg font-semibold text-indigo-300">Designing your dialogue...</span>
                </div>
            </div>

            <!-- Results Area -->
            <section id="results-area" class="hidden mt-8 rounded-lg bg-gray-700 shadow-xl" aria-live="polite" aria-atomic="true">
                <!-- Scripts will be injected here -->
            </section>
            
        </div>
    </main>

    <!-- Purchase Modal (Hidden by default) -->
    <div id="purchase-modal" class="modal fixed inset-0 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-krypton-card rounded-xl p-8 max-w-lg w-full shadow-2xl border-2 border-krypton-accent">
            <h2 class="text-3xl font-bold text-red-400 mb-4">Upgrade for Unlimited Access</h2>
            <p class="text-xl text-gray-200 mb-6">
                You've used all your **free script credits**. Ready to master every difficult conversation?
            </p>

            <div class="p-4 bg-gray-800 rounded-lg mb-6">
                <h3 class="text-2xl font-bold text-krypton-accent mb-2">Script Pack: 10 Uses</h3>
                <p class="text-4xl font-extrabold text-white">â¹499 <span class="text-lg font-medium text-gray-400"> (approx. $6 USD)</span></p>
                <p class="text-sm text-gray-400 mt-2">
                    *Pricing defaults to **INR** for Indian customers. Our live system detects your location to offer local currency pricing (USD, EUR, etc.) and uses **Razorpay** as the primary payment gateway for seamless India transactions.
                </p>
            </div>

            <button id="buy-scripts-btn" 
                    class="w-full p-4 text-xl font-bold rounded-lg bg-green-600 hover:bg-green-700 transition a11y-focus-ring mb-4">
                Buy 10 Scripts (â¹499)
            </button>
            
            <button id="close-modal-btn" 
                    class="w-full p-3 text-sm text-gray-400 hover:text-white transition a11y-focus-ring">
                Maybe later
            </button>
            <p class="text-xs text-center text-indigo-300 mt-4">Powered by kryptonpath.com</p>
        </div>
    </div>
</body>
</html>

