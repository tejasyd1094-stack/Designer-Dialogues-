<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KryptonPath Dialogue Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Razorpay Checkout SDK for payment processing -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght=300;400;600;700&family=Montserrat:wght=400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for aesthetic, modern, and vibrant design */
        :root {
            --primary-accent: #6C63FF; /* Vibrant Purple/Indigo */
            --secondary-accent: #FFD233; /* Bright Yellow/Gold */
            --background-dark: #1A1A2E; /* Deep Navy Blue */
            --card-background: #1F2840; /* Slightly lighter navy for cards */
            --text-light: #E0E0E0; /* Off-white for readability */
            --text-dark: #AAAAAA; /* Lighter grey for secondary text */
            --success-green: #3DDC84; /* Vibrant Green for success */
            --error-red: #FF6B6B; /* Soft Red for errors */
        }

        body {
            font-family: 'Poppins', sans-serif;
            /* Subtle background gradient for depth */
            background: linear-gradient(135deg, var(--background-dark) 0%, #151927 100%);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 0;
        }
        .a11y-focus-ring:focus {
            outline: 3px solid var(--secondary-accent);
            outline-offset: 2px;
        }
        .container-card {
            background-color: var(--card-background);
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.5);
        }
        .input-style, .select-style {
            background-color: #374151; /* Darker input background */
            border: 2px solid #4b5563;
            color: var(--text-light);
            transition: border-color 0.3s;
            /* Ensure select matches input height and style */
            appearance: none; /* Hide default arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23AAAAAA'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        .input-style:focus, .select-style:focus {
            border-color: var(--primary-accent);
        }
        .button-primary {
            background-color: var(--primary-accent);
            transition: background-color 0.3s, transform 0.1s;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #5d53ee; /* Darker shade on hover */
            transform: translateY(-1px);
        }
        .loading-dot {
            animation: bounce 0.6s infinite alternate;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            to {
                opacity: 0.5;
                transform: translateY(-8px);
            }
        }
        /* Notification/Message Box styles */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
        .pack-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .pack-card:hover {
            border-color: var(--primary-accent);
        }
        .pack-card.selected {
            border-color: var(--secondary-accent);
            background-color: rgba(255, 210, 51, 0.1);
            transform: scale(1.03);
        }
        .buy-button {
            background-color: var(--success-green);
            color: #1A1A2E; /* Dark text for contrast */
        }
        .buy-button:hover {
            background-color: #2da468;
        }
    </style>
</head>
<body class="selection:bg-primary-accent selection:text-white">

    <div class="max-w-xl w-full p-4 lg:p-8 container-card rounded-3xl">

        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tight">KryptonPath Dialogue Designer</h1>
            <h2 class="text-xl font-semibold text-primary-accent mb-4">The Zero-Conflict Corporate Dialogue Engine.</h2>
            <p class="text-lg text-text-dark max-w-md mx-auto">
                Instantly curate 3 professional, conflict-free scripts for any high-stakes work conversation.
            </p>
            <div id="credit-counter" class="inline-block mt-4 p-2 px-4 rounded-full bg-primary-accent shadow-lg">
                <span class="text-lg font-bold text-secondary-accent">0 Script Credits</span>
            </div>
            <!-- Button to always show purchase options -->
            <button id="buy-credits-link" class="mt-4 block mx-auto text-sm font-semibold text-white bg-[#374151] hover:bg-[#4b5563] px-6 py-2 rounded-full transition a11y-focus-ring">
                View Plans & Buy Scripts
            </button>
            
        </header>

        <!-- Form for input -->
        <form id="dialogue-form" class="space-y-6">
            
            <!-- 1. Situation Dropdown -->
            <div>
                <label for="situation" class="block text-sm font-medium mb-2 text-text-light">1. Select the corporate pain point (Situation):</label>
                <select id="situation" name="situation" required
                        class="select-style w-full p-3 rounded-lg a11y-focus-ring">
                    <option value="" disabled selected>Choose a common workplace challenge</option>
                    <option value="Handling unjustified criticism from a senior leader.">Handling unjustified criticism from a senior leader.</option>
                    <option value="Addressing a colleague who consistently misses deadlines.">Addressing a colleague who consistently misses deadlines.</option>
                    <option value="Negotiating a better salary/compensation package.">Negotiating a better salary/compensation package.</option>
                    <option value="Giving difficult performance feedback to a direct report.">Giving difficult performance feedback to a direct report.</option>
                    <option value="Pushing back against an overwhelming new project assignment.">Pushing back against an overwhelming new project assignment.</option>
                    <option value="Requesting essential resources or budget increase.">Requesting essential resources or budget increase.</option>
                    <option value="Explaining a major project failure or delay.">Explaining a major project failure or delay.</option>
                    <option value="Dealing with constant interruptions during meetings.">Dealing with constant interruptions during meetings.</option>
                </select>
            </div>

            <!-- 2. Role Dropdown -->
            <div>
                <label for="role" class="block text-sm font-medium mb-2 text-text-light">2. What is your role in this conversation?</label>
                <select id="role" name="role" required
                        class="select-style w-full p-3 rounded-lg a11y-focus-ring">
                    <option value="" disabled selected>Identify your role and audience</option>
                    <option value="Manager speaking to Direct Report.">Manager speaking to Direct Report.</option>
                    <option value="Direct Report speaking to Manager.">Direct Report speaking to Manager.</option>
                    <option value="Colleague speaking to Peer/Teammate.">Colleague speaking to Peer/Teammate.</option>
                    <option value="Leader speaking to a Cross-Functional Partner.">Leader speaking to a Cross-Functional Partner.</option>
                    <option value="Team Member speaking to a Project Stakeholder.">Team Member speaking to a Project Stakeholder.</option>
                </select>
            </div>

            <!-- 3. Mode Dropdown -->
            <div>
                <label for="mode" class="block text-sm font-medium mb-2 text-text-light">3. What is the communication mode?</label>
                <select id="mode" name="mode" required
                        class="select-style w-full p-3 rounded-lg a11y-focus-ring">
                    <option value="" disabled selected>How will you deliver the message?</option>
                    <option value="Verbal Conversation (In-person or Video Call).">Verbal Conversation (In-person or Video Call).</option>
                    <option value="Written Communication (Email/Memo).">Written Communication (Email/Memo).</option>
                    <option value="Instant Message (Slack/Teams).">Instant Message (Slack/Teams).</option>
                    <option value="Formal Presentation Script.">Formal Presentation Script.</option>
                </select>
            </div>

            <!-- Context Input (Remains text area for specificity) -->
            <div>
                <label for="context" class="block text-sm font-medium mb-2 text-text-light">4. Provide brief context (What specifically happened?):</label>
                <textarea id="context" name="context" rows="4" placeholder="Example: My manager frequently interrupts me during project updates, making me feel unheard and losing momentum on the topic." required
                          class="input-style w-full p-3 rounded-lg a11y-focus-ring resize-none"></textarea>
                <p class="text-xs text-text-dark mt-1">
                    Be specific about the last incident for the best three-script outcome.
                </p>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submit-btn" disabled 
                    class="button-primary w-full p-4 text-xl font-bold rounded-lg a11y-focus-ring opacity-70 cursor-not-allowed"
                    aria-live="polite">
                Generate Scripts (1 Credit)
            </button>
        </form>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center mt-8 p-4" role="status" aria-label="Generating scripts, please wait.">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-3 h-3 bg-primary-accent rounded-full loading-dot"></div>
                <div class="w-3 h-3 bg-primary-accent rounded-full loading-dot"></div>
                <div class="w-3 h-3 bg-primary-accent rounded-full loading-dot"></div>
                <span class="ml-3 text-lg font-semibold text-primary-accent">Crafting your zero-conflict dialogue...</span>
            </div>
        </div>

        <!-- Results Area -->
        <section id="results-area" class="hidden mt-8 rounded-xl bg-background-dark p-6 shadow-2xl" aria-live="polite" aria-atomic="true">
            <h3 class="text-2xl font-bold text-secondary-accent mb-4">Your Conflict-Free Scripts</h3>
            <div id="script-results" class="space-y-6">
                <!-- Content will be injected here -->
            </div>
        </section>
        
    </div>

    <!-- Modal for Purchase/Messaging -->
    <div id="dialogue-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-card-background p-6 lg:p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95 opacity-0" id="modal-content-box">
            
            <h2 id="modal-title" class="text-3xl font-extrabold text-secondary-accent mb-4 text-center">Unlock Scripts</h2>
            <p id="modal-message" class="text-text-light mb-6 text-center">
                Select a script pack below to expand your dialogue toolkit and continue generating professional, conflict-free conversations.
            </p>

            <!-- Pricing Grid - Defaults to hidden but will be shown by JS for purchase flow -->
            <div id="pricing-grid" class="hidden grid grid-cols-3 gap-4 mb-6">
                
                <!-- 10 Credits @ â¹299 (Starter Pack) -->
                <label for="starter-pack" id="starter-card" class="pack-card bg-background-dark p-4 rounded-lg text-center relative hover:border-primary-accent">
                    <input type="radio" id="starter-pack" name="scriptPack" value="10" data-price-inr="299" checked
                           class="absolute top-3 right-3 h-5 w-5 text-primary-accent bg-transparent border-gray-500 checked:bg-primary-accent focus:ring-0">
                    
                    <h3 class="text-lg font-bold text-primary-accent mb-1">STARTER</h3>
                    <p class="text-sm text-text-light mb-2">10 Scripts</p>
                    <p class="text-2xl font-extrabold text-white">â¹299</p>
                    <p class="text-xs text-text-dark mt-2 opacity-0">Placeholder</p>
                </label>

                <!-- 50 Credits @ â¹499 (Pro Pack) -->
                <label for="pro-pack" id="pro-card" class="pack-card bg-background-dark p-4 rounded-lg text-center relative hover:border-primary-accent">
                    <input type="radio" id="pro-pack" name="scriptPack" value="50" data-price-inr="499"
                           class="absolute top-3 right-3 h-5 w-5 text-primary-accent bg-transparent border-gray-500 checked:bg-primary-accent focus:ring-0">
                    
                    <h3 class="text-lg font-bold text-primary-accent mb-1">PRO</h3>
                    <p class="text-sm text-text-light mb-2">50 Scripts</p>
                    <p class="text-2xl font-extrabold text-white">â¹499</p>
                    <p class="text-xs text-text-dark mt-2 opacity-0">Placeholder</p>
                </label>

                <!-- 500 Credits @ â¹1999 (Titan Plan - Best Value) -->
                <label for="titan-pack" id="titan-card" class="pack-card bg-background-dark p-4 rounded-lg text-center relative border-2 border-secondary-accent shadow-lg">
                    <input type="radio" id="titan-pack" name="scriptPack" value="500" data-price-inr="1999"
                           class="absolute top-3 right-3 h-5 w-5 text-secondary-accent bg-transparent border-gray-500 checked:bg-secondary-accent focus:ring-0">
                    
                    <h3 class="text-lg font-bold text-secondary-accent mb-1">TITAN PLAN</h3>
                    <p class="text-sm text-text-light mb-2">500 Scripts</p>
                    <p class="text-2xl font-extrabold text-white">â¹1999</p>
                    <p class="text-xs text-success-green font-bold mt-2">
                        Best Value
                    </p>
                </label>
            </div>

            <p class="text-xs text-text-dark mb-4 mt-2 text-center">
                All transactions are in **INR (â¹)** and secured via **Razorpay**.
            </p>

            <button id="buy-scripts-btn" 
                    class="buy-button w-full p-4 text-xl font-bold rounded-lg transition a11y-focus-ring mb-4">
                Proceed to Secure Payment (â¹299)
            </button>
            
            <button id="close-modal-btn" 
                    class="w-full p-3 text-sm text-text-dark hover:text-white transition a11y-focus-ring">
                Go back to designer
            </button>
            <p class="text-xs text-text-dark mt-4 text-center">Powered by <a href="#" class="text-primary-accent hover:underline">Gemini</a> & <a href="#" class="text-primary-accent hover:underline">Firebase</a></p>
        </div>
    </div>
    
    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 opacity-0 transform translate-x-10 z-50"></div>


    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- CONFIG & INITIALIZATION ---
        
        // 1. Mandatory Global Variables & Fallback
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // --- REVISED CRITICAL CONFIGURATION BLOCK ---
        // This is the guaranteed configuration for external deployments (Netlify/Vercel)
        const FALLBACK_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBNxJAj9ioHSPyAYARd7KjWc-jw0I229Lo",
            authDomain: "zero-conflict.firebaseapp.com",
            projectId: "zero-conflict",
            storageBucket: "zero-conflict.firebasestorage.app",
            messagingSenderId: "818695765041",
            appId: "1:818695765041:web:f7206907bb3466d9a8e910",
            measurementId: "G-5SLFLYB88K"
        };
        
        // Determine the final configuration object using a guaranteed assignment.
        // It uses the Canvas config if available, otherwise it uses the user-provided fallback.
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
            ? JSON.parse(__firebase_config)
            : FALLBACK_FIREBASE_CONFIG;
        // --- END REVISED BLOCK ---

        // 2. Razorpay & Currency Configuration
        const RAZORPAY_KEY_ID = 'rzp_live_RdjxnHnfeuUS06';
        const CURRENCY_CODE = 'INR'; 
        
        // 3. Firebase Instances & State
        let app, db, auth;
        let userId = null;
        let currentCredits = 0;
        
        // 4. Gemini API Endpoint
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Elements
        const form = document.getElementById('dialogue-form');
        const submitBtn = document.getElementById('submit-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsArea = document.getElementById('results-area');
        const scriptResultsDiv = document.getElementById('script-results');
        const creditCounterSpan = document.querySelector('#credit-counter span');
        const modal = document.getElementById('dialogue-modal');
        const modalContentBox = document.getElementById('modal-content-box');
        const buyScriptsBtn = document.getElementById('buy-scripts-btn');
        const pricingGrid = document.getElementById('pricing-grid'); // Now defaults to hidden in HTML
        const buyCreditsLink = document.getElementById('buy-credits-link'); // Reference to the new button

        // Set Firebase Logging (Helpful for debugging)
        setLogLevel('debug');


        // --- UI & UX FUNCTIONS ---

        function showNotification(message, type = 'info') {
            const toast = document.getElementById('notification-toast');
            toast.textContent = message;
            
            // Set colors based on type
            let bgColor = 'bg-gray-800';
            if (type === 'error') bgColor = 'bg-error-red';
            else if (type === 'success') bgColor = 'bg-success-green';
            else if (type === 'info') bgColor = 'bg-primary-accent';

            toast.className = `fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 transform z-50 ${bgColor}`;
            
            // Show
            toast.classList.remove('opacity-0', 'translate-x-10');
            
            // Hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-10');
            }, 5000);
        }

        function showMessageBox(title, message, isPurchaseFlow) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;

            if (isPurchaseFlow) {
                // Show pricing grid and purchase button
                pricingGrid.classList.remove('hidden'); // CRITICAL: This now reveals the plans
                buyScriptsBtn.classList.remove('hidden');
                
                updateSelectedPack();
            } else {
                // Hide pricing grid and purchase button for simple alerts
                pricingGrid.classList.add('hidden');
                buyScriptsBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            // Trigger transition for aesthetics
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContentBox.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal() {
            modalContentBox.classList.add('scale-95', 'opacity-0');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('opacity-100');
            }, 300); // Match transition duration
        }

        function updateCreditUI(count) {
            currentCredits = count;
            creditCounterSpan.textContent = `${count} Script Credits`;
            
            const creditText = count <= 0 ? 'Out of Credits' : 'Generate Scripts (1 Credit)';
            submitBtn.textContent = creditText;

            if (count > 0) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-70', 'cursor-not-allowed');
            }
        }

        function updateSelectedPack() {
            const packs = document.querySelectorAll('.pack-card');
            const selectedInput = document.querySelector('input[name="scriptPack"]:checked');
            
            if (!selectedInput) return;

            const price = selectedInput.dataset.priceInr;
            buyScriptsBtn.textContent = `Proceed to Secure Payment (â¹${price})`;

            packs.forEach(card => {
                const input = card.querySelector('input[name="scriptPack"]');
                if (input.checked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }


        // --- FIREBASE LOGIC ---

        async function initFirebase() {
            try {
                
                // Safety check: Ensure the configuration is valid before proceeding
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Firebase configuration object is invalid or empty.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);

                if (initialAuthToken) {
                    // This block will only run in the Canvas environment
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // This is the path for external deployments like Netlify/Vercel
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Use the default-app-id for external deployments
                        setupCreditListener(userId); 
                    } else {
                        userId = null;
                        updateCreditUI(0);
                        showNotification('Authentication failed or user signed out.', 'error');
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showNotification(`Fatal Error: Could not initialize Firebase. Check console.`, 'error');
            }
        }

        function setupCreditListener(uid) {
            // Note: External deployments use 'default-app-id' in the path
            const creditDocRef = doc(db, 'artifacts', appId, 'users', uid, 'usage_credits', 'dialogue_app');
            
            onSnapshot(creditDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateCreditUI(data.count || 0);
                } else {
                    // Initialize document for new users with 3 free credits
                    setDoc(creditDocRef, { count: 3, userId: uid, lastUsed: new Date().toISOString() })
                        .then(() => updateCreditUI(3))
                        .catch(e => console.error("Error creating initial credit doc:", e));
                }
            }, (error) => {
                console.error("Credit Listener Error:", error);
                showNotification('Failed to listen for credit updates.', 'error');
            });
        }

        async function decrementCredit() {
            if (!db || !userId) return false;

            const creditDocRef = doc(db, 'artifacts', appId, 'users', userId, 'usage_credits', 'dialogue_app');
            
            try {
                const success = await runTransaction(db, async (transaction) => {
                    const creditDoc = await transaction.get(creditDocRef);
                    
                    if (!creditDoc.exists() || creditDoc.data().count <= 0) {
                        return false; 
                    }

                    const newCount = creditDoc.data().count - 1;
                    
                    transaction.set(creditDocRef, {
                        count: newCount,
                        lastUsed: new Date().toISOString()
                    }, { merge: true });
                    
                    return true;
                });
                
                return success;

            } catch (e) {
                console.error("Credit decrement transaction failed:", e);
                showNotification('Failed to use credit due to database error.', 'error');
                return false;
            }
        }

        // --- PURCHASE LOGIC (Razorpay Integration) ---
        
        async function grantCredits(addedCredits, paymentId) {
            if (!db || !userId) {
                console.error("Cannot grant credits: Firebase or User ID not ready.");
                showNotification("Payment confirmed, but failed to grant credits. Contact support.", 'error');
                return;
            }

            const creditDocRef = doc(db, 'artifacts', appId, 'users', userId, 'usage_credits', 'dialogue_app');
            
            try {
                // Use a transaction to safely read the current count and write the new count
                const newCount = await runTransaction(db, async (transaction) => {
                    const creditDoc = await transaction.get(creditDocRef);
                    
                    let currentCount = 0;
                    if (creditDoc.exists()) {
                        currentCount = creditDoc.data().count;
                    } 
                    
                    const finalCount = currentCount + addedCredits;
                    
                    // Write the new count
                    transaction.set(creditDocRef, {
                        count: finalCount,
                        userId: userId, 
                        lastPurchase: new Date().toISOString(),
                        lastPaymentId: paymentId
                    }, { merge: true }); 
                    
                    return finalCount; // Return the new count to the outside scope
                });

                // Transaction successful (Critical Notification - KEEP)
                showNotification(`Purchase Complete! ${addedCredits} Scripts added. Total credits: ${newCount}`, 'success');
                closeModal();
                
            } catch (e) {
                console.error("FIREBASE TRANSACTION ERROR (Credit Granting Failed):", e);
                // Critical Notification - KEEP
                showNotification(`Payment confirmed, but failed to grant credits. Contact support.`, 'error');
            }
        }
        
        function handleBuyScripts() {
            if (!db || !userId) {
                showMessageBox("System Error", "App not fully initialized. Please wait a moment and try again. (Firebase configuration error)", false);
                return;
            }

            const selectedPackElement = document.querySelector('input[name="scriptPack"]:checked');
            if (!selectedPackElement) {
                showMessageBox("Selection Error", "Please select a script pack before proceeding.", false);
                return;
            }

            const addedCredits = parseInt(selectedPackElement.value);
            const priceInRupees = parseInt(selectedPackElement.dataset.priceInr);
            
            // Razorpay amount must be in the smallest unit (Paisa)
            const amountInPaisa = priceInRupees * 100;

            const options = {
                key: RAZORPAY_KEY_ID, // Your Key ID from Razorpay Dashboard
                amount: amountInPaisa, 
                currency: CURRENCY_CODE,
                name: 'KryptonPath Designer',
                description: `Purchase ${addedCredits} Dialogue Scripts`,
                // Note: In a real application, the server would generate an Order ID for security/tracking.
                prefill: {
                    name: auth.currentUser?.displayName || 'Anonymous User',
                    email: auth.currentUser?.email || 'user@example.com' 
                },
                handler: function (response) {
                    // This function is called on successful payment
                    if (response.razorpay_payment_id) {
                        // Crucial: Grant credits only after successful payment
                        grantCredits(addedCredits, response.razorpay_payment_id);
                    } else {
                        // Should not happen with standard Razorpay flow
                        showNotification('Payment successful but no ID received. Contact support.', 'error');
                    }
                },
                modal: {
                    ondismiss: function() {
                        // User closed the modal without payment
                        showNotification('Payment attempt cancelled.', 'info');
                    }
                }
            };
            
            try {
                const rzp1 = new Razorpay(options);
                rzp1.open();
                
            } catch (error) {
                console.error("Razorpay Initialization Failed:", error);
                showNotification("Failed to open payment gateway. Check browser console.", 'error');
            }
        }


        // --- LLM GENERATION LOGIC ---

        async function handleGenerateScripts(event) {
            event.preventDefault();
            
            const situationEl = document.getElementById('situation');
            const roleEl = document.getElementById('role');
            const modeEl = document.getElementById('mode');
            
            if (!situationEl.value || !roleEl.value || !modeEl.value || !document.getElementById('context').value) {
                showMessageBox("Missing Information", "Please select options for Situation, Role, and Mode, and provide context to generate scripts.", false);
                return;
            }


            if (currentCredits <= 0) {
                // IMPORTANT: isPurchaseFlow is TRUE, which will show the pricing grid.
                showMessageBox("Unlock Scripts", "You've used all your **free script credits**. Please purchase a script pack to continue mastering your dialogues.", true);
                return;
            }

            // Start loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            loadingIndicator.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            
            const formData = new FormData(form);
            const situation = formData.get('situation');
            const role = formData.get('role');
            const mode = formData.get('mode');
            const context = formData.get('context');

            const systemPrompt = `You are the KryptonPath Dialogue Designer, a world-class communication AI. Your task is to generate three distinct, conflict-free professional dialogue scripts based on the user's input. The response MUST be in Markdown format, with three clearly separated scripts under H2 headings (##).

1.  **Direct Script (Action-Oriented):** Focus on clarity, boundaries, and immediate resolution.
2.  **Empathetic Script (Relationship-Focused):** Focus on understanding, shared goals, and collaborative problem-solving.
3.  **Formal Script (Documentation-Ready):** Focus on professional language, objective facts, and formal documentation (e.g., an email or official verbal statement).

Ensure all scripts are professional, respectful, and achieve the user's objective without escalating conflict. Use placeholders like [Manager's Name] or [Specific Date].`;

            const userQuery = `SITUATION: ${situation}\nROLE: ${role}\nMODE: ${mode}\nCONTEXT: ${context}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // Use exponential backoff for retries
            const maxRetries = 3;
            let retryCount = 0;
            let response;

            while (retryCount < maxRetries) {
                try {
                    const creditUsed = await decrementCredit();
                    if (!creditUsed) {
                        // Re-open purchase modal if credit ran out during async execution (unlikely, but safe)
                        showMessageBox("Unlock Scripts", "You ran out of credits during processing. Please purchase a script pack.", true);
                        return;
                    }

                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    }

                    if (response.status === 429) {
                        retryCount++;
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry request
                    }

                    throw new Error(`API returned status ${response.status}`);

                } catch (error) {
                    console.error(`Generation attempt ${retryCount + 1} failed:`, error);
                    if (retryCount === maxRetries - 1) {
                        showNotification('Failed to generate scripts after multiple attempts. Please try again.', 'error');
                        loadingIndicator.classList.add('hidden');
                        updateCreditUI(currentCredits); // Restore button state
                        return;
                    }
                    retryCount++;
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            // Process response
            try {
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    displayResults(text);
                } else {
                    throw new Error("Received empty or malformed response from AI.");
                }

            } catch (error) {
                console.error("Response processing error:", error);
                showNotification('Error processing AI response. Please check your prompt.', 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
                updateCreditUI(currentCredits); // Update button state
            }
        }

        function displayResults(markdownText) {
            // Simple Markdown-to-HTML conversion for the three main sections
            scriptResultsDiv.innerHTML = '';
            
            const sections = markdownText.split('##').filter(s => s.trim() !== '');

            sections.forEach(section => {
                const lines = section.trim().split('\n');
                const title = lines[0].trim();
                const content = lines.slice(1).join('\n').trim().replace(/\n/g, '<br>');

                const card = document.createElement('div');
                card.className = 'bg-card-background p-5 rounded-lg border-l-4 border-primary-accent shadow-md';
                card.innerHTML = `
                    <h4 class="text-xl font-semibold text-text-light mb-2">${title}</h4>
                    <p class="text-text-dark text-sm leading-relaxed">${content}</p>
                `;
                scriptResultsDiv.appendChild(card);
            });

            resultsArea.classList.remove('hidden');
            resultsArea.scrollIntoView({ behavior: 'smooth' });
        }
        
        // --- EVENT LISTENERS ---

        window.onload = initFirebase;
        form.addEventListener('submit', handleGenerateScripts);
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);
        buyScriptsBtn.addEventListener('click', handleBuyScripts);
        
        // NEW: Listener for the always-visible Buy Credits button
        buyCreditsLink.addEventListener('click', () => {
            showMessageBox(
                "KryptonPath Script Packs", 
                "Select a script pack below to expand your dialogue toolkit and continue generating professional, conflict-free conversations.", 
                true // isPurchaseFlow = true to show the pricing grid
            );
        });

        // Modal radio button change listener
        document.querySelectorAll('input[name="scriptPack"]').forEach(input => {
            input.addEventListener('change', updateSelectedPack);
        });

        // Ensure initial selection highlight and button text for the Starter pack
        document.addEventListener('DOMContentLoaded', () => {
            const starterInput = document.getElementById('starter-pack');
            if (starterInput) {
                starterInput.checked = true; // Select by default
                updateSelectedPack();
            }
        });


    </script>
</body>
</html>

