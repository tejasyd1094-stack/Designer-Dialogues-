<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KryptonPath Dialogue Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Montserrat:wght=400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for aesthetic, modern, and vibrant design */
        :root {
            --primary-accent: #6C63FF; /* Vibrant Purple/Indigo */
            --secondary-accent: #FFD233; /* Bright Yellow/Gold */
            --background-dark: #1A1A2E; /* Deep Navy Blue */
            --card-background: #1F2840; /* Slightly lighter navy for cards */
            --text-light: #E0E0E0; /* Off-white for readability */
            --text-dark: #AAAAAA; /* Lighter grey for secondary text */
            --success-green: #3DDC84; /* Vibrant Green for success */
            --error-red: #FF6B6B; /* Soft Red for errors */
        }

        body {
            font-family: 'Poppins', sans-serif;
            /* Subtle background gradient for depth */
            background: linear-gradient(135deg, var(--background-dark) 0%, #0F121C 100%);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container-card {
            background-color: var(--card-background);
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(108, 99, 255, 0.2); 
            position: relative;
            overflow: hidden; 
        }

        /* Subtle glow effect on the card */
        .container-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at top left, rgba(108, 99, 255, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at bottom right, rgba(255, 210, 51, 0.1) 0%, transparent 40%);
            opacity: 0.3;
            z-index: 0;
            pointer-events: none;
        }

        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-light);
            font-weight: 700;
        }

        .input-style {
            background-color: rgba(255, 255, 255, 0.08); 
            border: 1px solid rgba(108, 99, 255, 0.4); 
            color: var(--text-light);
            padding: 0.8rem 1rem;
            border-radius: 0.75rem; 
            transition: border-color 0.3s, background-color 0.3s;
        }

        .input-style:focus {
            border-color: var(--secondary-accent); 
            background-color: rgba(255, 255, 255, 0.15);
            outline: none;
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.3); 
        }

        .button-primary {
            background: linear-gradient(90deg, #6C63FF 0%, #8A63FF 100%); /* Gradient button */
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 700;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(108, 99, 255, 0.3);
        }

        .button-primary:hover {
            background: linear-gradient(90deg, #8A63FF 0%, #6C63FF 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 20px rgba(108, 99, 255, 0.4);
        }
        .button-primary:disabled {
            background: #4A4A5A;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
        }

        .a11y-focus-ring:focus {
            outline: 3px solid var(--secondary-accent);
            outline-offset: 3px;
        }

        /* Modal Styles */
        .modal {
            background-color: rgba(0, 0, 0, 0.85); 
        }
        .modal-content {
            background-color: var(--card-background);
            border: 1px solid var(--primary-accent);
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }
        
        /* Pricing Tier Card Styles */
        .credit-pack-info {
            background-color: rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
        }
        .credit-pack-info:has(input:checked) {
            border-color: var(--secondary-accent) !important;
            box-shadow: 0 0 10px rgba(255, 210, 51, 0.5);
        }

        .buy-button {
            background: linear-gradient(90deg, #3DDC84 0%, #2DBB70 100%);
            box-shadow: 0 5px 15px rgba(61, 220, 132, 0.3);
            color: black; 
            font-weight: 700;
        }
        .buy-button:hover {
            background: linear-gradient(90deg, #2DBB70 0%, #3DDC84 100%);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(61, 220, 132, 0.4);
        }

        /* Loading Animation */
        .loading-dot {
            animation: dot-flicker 1.5s infinite ease-in-out;
            background-color: var(--primary-accent);
        }
        .loading-dot:nth-child(2) { animation-delay: 0.5s; }
        .loading-dot:nth-child(3) { animation-delay: 1s; }
        @keyframes dot-flicker {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
    </style>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Globals ---
        const API_KEY = ""; // Provided by the environment
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'dialogue-designer';
        const FIREBASE_CONFIG = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db = null;
        let auth = null;
        let userId = null;
        let credits = 0;
        const INITIAL_CREDITS = 3;

        // --- DOM Elements ---
        const resultsDiv = document.getElementById('results-area');
        const loaderDiv = document.getElementById('loading-indicator');
        const submitButton = document.getElementById('submit-btn');
        const creditCounter = document.getElementById('credit-counter');
        const purchaseModal = document.getElementById('purchase-modal');
        const closeModalButton = document.getElementById('close-modal-btn');
        const buyScriptsButton = document.getElementById('buy-scripts-btn');
        const form = document.getElementById('dialogue-form');

        // --- Event Listeners ---
        closeModalButton.addEventListener('click', () => purchaseModal.classList.add('hidden'));
        buyScriptsButton.addEventListener('click', mockPurchase);
        form.addEventListener('submit', handleFormSubmit);

        // --- Utility Functions ---

        /**
         * Gets the currently selected script pack details from the modal.
         */
        function getSelectedPack() {
            const selectedRadio = document.querySelector('input[name="scriptPack"]:checked');
            if (selectedRadio) {
                return {
                    credits: parseInt(selectedRadio.value),
                    price: parseInt(selectedRadio.getAttribute('data-price'))
                };
            }
            return null;
        }


        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            if (!FIREBASE_CONFIG) {
                console.error("Firebase config is missing. Cannot initialize database.");
                return;
            }

            const app = initializeApp(FIREBASE_CONFIG);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); 

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Authenticated with UID:", userId);
                    await loadCredits();
                } else {
                    if (INITIAL_AUTH_TOKEN) {
                        try {
                            await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                        } catch (error) {
                            console.error("Custom token sign-in failed:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        }

        /**
         * Loads user credits from Firestore, setting default if new user.
         */
        async function loadCredits() {
            if (!db || !userId) return;

            // Path: /artifacts/{appId}/users/{userId}/usage_credits/dialogue_app
            const creditRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'usage_credits', 'dialogue_app');

            try {
                const docSnap = await getDoc(creditRef);
                if (docSnap.exists()) {
                    credits = docSnap.data().count || 0;
                } else {
                    // New user: grant initial credits
                    credits = INITIAL_CREDITS;
                    await setDoc(creditRef, { count: credits, userId: userId, lastUpdated: new Date().toISOString() });
                }
            } catch (e) {
                console.error("Error loading credits:", e);
                credits = INITIAL_CREDITS; // Fail-safe
            }
            updateCreditUI();
        }

        /**
         * Checks if credits exist, decrements them, and saves to Firestore.
         */
        async function checkAndDecrementCredits() {
            if (credits <= 0) {
                return false;
            }

            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return true; 
            }

            try {
                const newCount = credits - 1;
                const creditRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'usage_credits', 'dialogue_app');
                await setDoc(creditRef, { count: newCount, userId: userId, lastUpdated: new Date().toISOString() }, { merge: false });
                credits = newCount;
                updateCreditUI();
                return true;
            } catch (e) {
                console.error("Error decrementing credits:", e);
                credits--; 
                updateCreditUI();
                return true; 
            }
        }

        /**
         * Updates the UI to show the current credit count and button state.
         */
        function updateCreditUI() {
            creditCounter.textContent = `${credits} Script Credits`;
            if (credits <= 0) {
                submitButton.disabled = true;
                submitButton.textContent = 'Out of Credits';
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                submitButton.classList.remove('hover:bg-indigo-500'); 
            } else {
                submitButton.disabled = false;
                submitButton.textContent = 'Generate Scripts (1 Credit)';
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                submitButton.classList.add('hover:bg-indigo-500'); 
            }
        }

        /**
         * Handles the form submission event (Check credits, generate, decrement).
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            resultsDiv.innerHTML = '';
            resultsDiv.classList.add('hidden');
            
            if (credits <= 0) {
                purchaseModal.classList.remove('hidden');
                return;
            }

            const formData = new FormData(form);
            const situation = formData.get('situation');
            const role = formData.get('role');
            const context = formData.get('context');
            
            if (!situation || !role || !context) {
                resultsDiv.innerHTML = '<p class="text-error-red p-4 rounded-lg bg-red-900 bg-opacity-30" role="alert">Please fill out all fields.</p>';
                resultsDiv.classList.remove('hidden');
                return;
            }

            // Show loading state and disable button
            loaderDiv.classList.remove('hidden');
            submitButton.disabled = true;
            submitButton.textContent = 'Generating...';

            try {
                const isAllowed = await checkAndDecrementCredits();
                if (!isAllowed) {
                    purchaseModal.classList.remove('hidden');
                    return;
                }

                const { text, sources } = await generateScripts(situation, role, context);
                displayResults(text, sources);
                
            } catch (error) {
                console.error("Generation error:", error);
                resultsDiv.innerHTML = '<p class="text-error-red p-4 rounded-lg bg-red-900 bg-opacity-30" role="alert">An error occurred while generating scripts. Please try again. (Check console for details.)</p>';
                resultsDiv.classList.remove('hidden');
            } finally {
                // Hide loading state
                loaderDiv.classList.add('hidden');
                updateCreditUI(); 
            }
        }

        /**
         * The core function to call the Gemini API for script generation.
         */
        async function generateScripts(situation, role, context) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

            const systemPrompt = `You are the KryptonPath Dialogue Designer. Your goal is to provide three distinct, professionally polished script options for sensitive workplace conversations. 
                The user has specified their situation and role.
                Your response MUST be structured using clear H2 titles for each script type: "## 1. Direct Script (Action-Oriented)", "## 2. Empathetic Script (Relationship-Focused)", and "## 3. Formal Script (Documentation-Ready)".
                Each script MUST be presented as a simple dialogue between the user and the 'Recipient'. Do not add any introductory or concluding text outside of the three scripts.`;

            const userQuery = `Generate three conversation scripts.
                - **Situation/Topic:** ${situation}
                - **My Role:** ${role}
                - **Brief Context:** ${context}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error("API call failed.");
            
            const result = await response.json();
            const candidate = result.candidates?.[0];
            const text = candidate?.content?.parts?.[0]?.text || '';
            
            // Note: Source extraction logic omitted as LLM call is only for script generation here.
            let sources = [];
            return { text, sources };
        }

        /**
         * Displays the generated markdown results with proper formatting.
         */
        function displayResults(markdownText, sources) {
            let html = markdownText.replace(/## (.*)/g, (match, title) => 
                `<h2 class="text-2xl font-bold text-primary-accent mt-6 mb-3 border-b border-gray-700 pb-2">${title}</h2>`
            );
            html = html.replace(/\n/g, '<p class="mb-4 text-text-light">'); 

            let sourcesHtml = ''; // Sources handling omitted for brevity/relevance, but structured for future use
            
            resultsDiv.innerHTML = `<div class="p-6 space-y-4 relative z-10">${html}${sourcesHtml}</div>`;
            resultsDiv.classList.remove('hidden');
            resultsDiv.setAttribute('aria-live', 'polite');
        }
        
        /**
         * Simulates the payment process (Razorpay initiation) and grants credits.
         */
        async function mockPurchase() {
            const selectedPack = getSelectedPack();
            if (!selectedPack) {
                // Should not happen if a radio button is checked by default
                return;
            }

            const { credits: addedCredits, price } = selectedPack;

            // In a live app, this would initiate a Razorpay checkout session 
            // with amount = price * 100 (for paisa conversion) and currency 'INR'.
            buyScriptsButton.disabled = true;
            buyScriptsButton.textContent = `Initiating Razorpay Checkout (₹${price})...`;

            // Simulate API call to payment gateway (3 second delay)
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // --- MOCK PAYMENT SUCCESS WEBHOOK ---
            
            try {
                // Grant credits after successful payment (mocked)
                const newCount = credits + addedCredits;
                const creditRef = doc(db, 'artifacts', APP_ID, 'users', userId, 'usage_credits', 'dialogue_app');
                
                // Save the new credit balance
                await setDoc(creditRef, { 
                    count: newCount, 
                    userId: userId, 
                    lastUpdated: new Date().toISOString(),
                    lastPurchase: { credits: addedCredits, price: price, currency: 'INR' } // Record purchase
                }, { merge: false });
                credits = newCount;
                
                // Success message
                alert(`Purchase successful! ${addedCredits} new credits added. You can now generate more scripts.`);
                purchaseModal.classList.add('hidden');
                
            } catch (e) {
                console.error("Error granting credits after mock purchase:", e);
                alert('Payment simulated, but an error occurred updating your credits. Please contact support.');
            } finally {
                updateCreditUI();
                buyScriptsButton.disabled = false;
                buyScriptsButton.textContent = 'Proceed to Secure Payment';
            }
        }

        window.onload = initializeFirebase;
    </script>
</head>
<body class="min-h-screen">
    <main class="w-full max-w-4xl">
        

<div class="container-card w-full">
            <header class="text-center mb-8 relative z-10">
                <h1 class="text-3xl md:text-4xl font-extrabold mb-2">
                    KryptonPath <span class="text-secondary-accent">Dialogue Designer</span>
                </h1>
                <p class="text-text-dark max-w-xl mx-auto">
                    Master sensitive conversations with AI-powered, professional scripts tailored to your situation.
                </p>
                <div class="mt-6 p-3 bg-card-background rounded-lg inline-block border border-primary-accent text-secondary-accent font-semibold text-lg">
                    <p>
                        <span id="credit-counter">Loading...</span>
                    </p>
                </div>
            </header>

            

<form id="dialogue-form" class="space-y-6 relative z-10">
                
                

<div>
                    <label for="situation-select" class="block text-lg font-medium mb-2 text-text-light">
                        1. Select the situation/topic:
                    </label>
                    <select id="situation-select" name="situation" required class="input-style w-full a11y-focus-ring">
                        <option value="">-- Choose High-Stakes Conversation --</option>
                        <option value="Discussing subtle workplace bias/microaggressions">Discussing Bias/Microaggressions</option>
                        <option value="Requesting accommodations for a disability or neurodivergence">Requesting Accommodations</option>
                        <option value="Giving difficult performance feedback to a team member">Giving Difficult Feedback</option>
                        <option value="Negotiating a salary increase or promotion">Negotiating Salary/Promotion</option>
                        <option value="Challenging a decision made by a senior mentor or leader">Challenging a Leader's Decision</option>
                        <option value="Addressing inappropriate use of diversity labels">Addressing Inappropriate Language</option>
                    </select>
                </div>

                

<div>
                    <label for="role-select" class="block text-lg font-medium mb-2 text-text-light">
                        2. What is your role in this conversation?
                    </label>
                    <select id="role-select" name="role" required class="input-style w-full a11y-focus-ring">
                        <option value="">-- Select Your Position --</option>
                        <option value="Employee reporting to Manager">Employee (Report to Manager)</option>
                        <option value="Manager speaking to Direct Report">Manager (Speak to Direct Report)</option>
                        <option value="Peer/Colleague engaging a peer">Peer/Colleague</option>
                        <option value="Mentor speaking to Mentee">Mentor</option>
                    </select>
                </div>

                

<div>
                    <label for="context-input" class="block text-lg font-medium mb-2 text-text-light">
                        3. Provide brief context (What happened? Who is involved?):
                    </label>
                    <textarea id="context-input" name="context" required placeholder="Example: My manager frequently interrupts me when I discuss project timelines, and it feels dismissive."
                           class="input-style w-full h-32 a11y-focus-ring" 
                           aria-describedby="context-help"></textarea>
                    <p id="context-help" class="text-sm text-text-dark mt-1">
                        Be specific for the most helpful scripts. Max 200 words.
                    </p>
                </div>

                

<button type="submit" id="submit-btn" disabled 
                        class="button-primary w-full a11y-focus-ring"
                        aria-live="polite">
                    Loading Credits...
                </button>
            </form>

            

<div id="loading-indicator" class="hidden text-center mt-8 p-4 relative z-10" role="status" aria-label="Generating scripts, please wait.">
                <div class="flex items-center justify-center space-x-2">
                    <div class="w-3 h-3 rounded-full loading-dot"></div>
                    <div class="w-3 h-3 rounded-full loading-dot"></div>
                    <div class="w-3 h-3 rounded-full loading-dot"></div>
                    <span class="ml-3 text-lg font-semibold text-primary-accent">Designing your dialogue...</span>
                </div>
            </div>

            

<section id="results-area" class="hidden mt-8 rounded-lg bg-background-dark p-6 shadow-xl relative z-10" aria-live="polite" aria-atomic="true">
                

</section>
            
        </div>
    </main>

    

<div id="purchase-modal" class="modal fixed inset-0 hidden flex items-center justify-center p-4 z-50">
        <div class="modal-content p-8 max-w-xl w-full text-center relative">
            <h2 class="text-3xl font-bold text-secondary-accent mb-4">Unlock More Scripts</h2>
            <p class="text-xl text-text-light mb-6">
                You've used all your **free script credits**. Choose a pack to continue mastering conversations.
            </p>

            <!-- Pricing Tiers (New) -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Pack A: 5 Credits -->
                <label class="credit-pack-info cursor-pointer p-4 rounded-xl transition duration-300 hover:scale-[1.03] border-2 border-transparent has-[:checked]:border-secondary-accent relative">
                    <input type="radio" name="scriptPack" value="5" data-price="199" class="absolute top-3 right-3 h-5 w-5 text-secondary-accent bg-transparent border-gray-500 checked:bg-secondary-accent focus:ring-0" checked>
                    <h3 class="text-2xl font-bold text-primary-accent mb-1">5 Scripts</h3>
                    <p class="text-4xl font-extrabold text-white">₹199</p>
                    <p class="text-sm text-text-dark mt-2">~ $2.40 USD / ~ €2.20 EUR</p>
                </label>
                
                <!-- Pack B: 10 Credits (Best Value) -->
                <label class="credit-pack-info cursor-pointer p-4 rounded-xl transition duration-300 hover:scale-[1.03] border-2 border-transparent has-[:checked]:border-secondary-accent relative">
                    <input type="radio" name="scriptPack" value="10" data-price="299" class="absolute top-3 right-3 h-5 w-5 text-secondary-accent bg-transparent border-gray-500 checked:bg-secondary-accent focus:ring-0">
                    <span class="absolute top-[-10px] right-[-10px] bg-secondary-accent text-card-background text-xs font-bold px-3 py-1 rounded-full shadow-lg transform rotate-3">BEST VALUE</span>
                    <h3 class="text-2xl font-bold text-primary-accent mb-1">10 Scripts</h3>
                    <p class="text-4xl font-extrabold text-white">₹299</p>
                    <p class="text-sm text-text-dark mt-2">~ $3.60 USD / ~ €3.30 EUR</p>
                </label>
            </div>

            <p class="text-xs text-text-dark mb-4 mt-2">
                **All INR transactions are processed securely via **Razorpay**. Other currencies via Stripe/International Gateway.
            </p>

            <button id="buy-scripts-btn" 
                    class="buy-button w-full p-4 text-xl font-bold rounded-lg transition a11y-focus-ring mb-4">
                Proceed to Secure Payment
            </button>
            
            <button id="close-modal-btn" 
                    class="w-full p-3 text-sm text-text-dark hover:text-white transition a11y-focus-ring">
                Go back to designer
            </button>
            <p class="text-xs text-text-dark mt-4">Powered by <a href="https://kryptonpath.com" target="_blank" class="text-primary-accent hover:underline">kryptonpath.com</a></p>
        </div>
    </div>
</body>
</html>

