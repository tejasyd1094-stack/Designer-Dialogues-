<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KryptonPath Dialogue Designer - Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for aesthetic, modern, and vibrant design */
        :root {
            --primary-accent: #6C63FF; /* Vibrant Purple/Indigo */
            --secondary-accent: #FFD233; /* Bright Yellow/Gold */
            --background-dark: #1A1A2E; /* Deep Navy Blue */
            --card-background: #1F2840; /* Slightly lighter navy for cards */
            --text-light: #E0E0E0; /* Off-white for readability */
            --text-dark: #AAAAAA; /* Lighter grey for secondary text */
            --success-green: #3DDC84; /* Vibrant Green for success */
            --error-red: #FF6B6B; /* Soft Red for errors */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, #151927 100%);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 0;
        }
        .a11y-focus-ring:focus {
            outline: 3px solid var(--secondary-accent);
            outline-offset: 2px;
        }
        .container-card {
            background-color: var(--card-background);
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.5);
        }
        .input-style, .select-style {
            background-color: #374151; /* Darker input background */
            border: 2px solid #4b5563;
            color: var(--text-light);
            transition: border-color 0.3s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23AAAAAA'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        .input-style:focus, .select-style:focus {
            border-color: var(--primary-accent);
        }
        .button-primary {
            background-color: var(--primary-accent);
            transition: background-color 0.3s, transform 0.1s;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #5d53ee;
            transform: translateY(-1px);
        }
        .loading-dot {
            animation: bounce 0.6s infinite alternate;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            to {
                opacity: 0.5;
                transform: translateY(-8px);
            }
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
        .pack-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .pack-card:hover {
            border-color: var(--primary-accent);
        }
        .pack-card.selected {
            border-color: var(--secondary-accent);
            background-color: rgba(255, 210, 51, 0.1);
            transform: scale(1.03);
        }
        .buy-button {
            background-color: var(--success-green);
            color: #1A1A2E;
        }
        .buy-button:hover {
            background-color: #2da468;
        }
    </style>
</head>
<body class="selection:bg-primary-accent selection:text-white">

    <div class="max-w-xl w-full p-4 lg:p-8 container-card rounded-3xl">

        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tight">KryptonPath Dialogue Designer</h1>
            <h2 class="text-xl font-semibold text-primary-accent mb-4">The Zero-Conflict Corporate Dialogue Engine.</h2>
            <p class="text-lg text-text-dark max-w-md mx-auto">
                Instantly curate 3 professional, conflict-free scripts for any high-stakes work conversation.
            </p>
            <div id="credit-counter" class="inline-block mt-4 p-2 px-4 rounded-full bg-primary-accent shadow-lg">
                <span class="text-lg font-bold text-secondary-accent">3 Script Credits (Demo)</span>
            </div>
            <!-- Button to always show purchase options -->
            <button id="buy-credits-link" class="mt-4 block mx-auto text-sm font-semibold text-white bg-[#374151] hover:bg-[#4b5563] px-6 py-2 rounded-full transition a11y-focus-ring">
                View Plans & Buy Scripts
            </button>
            
        </header>

        <!-- Form for input -->
        <form id="dialogue-form" class="space-y-6">
            
            <!-- 1. Situation Dropdown -->
            <div>
                <label for="situation" class="block text-sm font-medium mb-2 text-text-light">1. Select the corporate pain point (Situation):</label>
                <select id="situation" name="situation" required
                        class="select-style w-full p-3 rounded-lg a11y-focus-ring">
                    <option value="" disabled selected>Choose a common workplace challenge</option>
                    <option value="Handling unjustified criticism from a senior leader.">Handling unjustified criticism from a senior leader.</option>
                    <option value="Addressing a colleague who consistently misses deadlines.">Addressing a colleague who consistently misses deadlines.</option>
                    <option value="Negotiating a better salary/compensation package.">Negotiating a better salary/compensation package.</option>
                    <option value="Giving difficult performance feedback to a direct report.">Giving difficult performance feedback to a direct report.</option>
                    <option value="Pushing back against an overwhelming new project assignment.">Pushing back against an overwhelming new project assignment.</option>
                </select>
            </div>

            <!-- 2. Role Dropdown -->
            <div>
                <label for="role" class="block text-sm font-medium mb-2 text-text-light">2. What is your role in this conversation?</label>
                <select id="role" name="role" required
                        class="select-style w-full p-3 rounded-lg a11y-focus-ring">
                    <option value="" disabled selected>Identify your role and audience</option>
                    <option value="Manager speaking to Direct Report.">Manager speaking to Direct Report.</option>
                    <option value="Direct Report speaking to Manager.">Direct Report speaking to Manager.</option>
                    <option value="Colleague speaking to Peer/Teammate.">Colleague speaking to Peer/Teammate.</option>
                </select>
            </div>

            <!-- 3. Mode Dropdown -->
            <div>
                <label for="mode" class="block text-sm font-medium mb-2 text-text-light">3. What is the communication mode?</label>
                <select id="mode" name="mode" required
                        class="select-style w-full p-3 rounded-lg a11y-focus-ring">
                    <option value="" disabled selected>How will you deliver the message?</option>
                    <option value="Verbal Conversation (In-person or Video Call).">Verbal Conversation (In-person or Video Call).</option>
                    <option value="Written Communication (Email/Memo).">Written Communication (Email/Memo).</option>
                    <option value="Instant Message (Slack/Teams).">Instant Message (Slack/Teams).</option>
                </select>
            </div>

            <!-- Context Input (Remains text area for specificity) -->
            <div>
                <label for="context" class="block text-sm font-medium mb-2 text-text-light">4. Provide brief context (What specifically happened?):</label>
                <textarea id="context" name="context" rows="4" placeholder="Example: My manager frequently interrupts me during project updates, making me feel unheard and losing momentum on the topic." required
                          class="input-style w-full p-3 rounded-lg a11y-focus-ring resize-none"></textarea>
                <p class="text-xs text-text-dark mt-1">
                    Be specific about the last incident for the best three-script outcome.
                </p>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submit-btn" 
                    class="button-primary w-full p-4 text-xl font-bold rounded-lg a11y-focus-ring"
                    aria-live="polite">
                Generate Scripts (1 Credit)
            </button>
        </form>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center mt-8 p-4" role="status" aria-label="Generating scripts, please wait.">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-3 h-3 bg-primary-accent rounded-full loading-dot"></div>
                <div class="w-3 h-3 bg-primary-accent rounded-full loading-dot"></div>
                <div class="w-3 h-3 bg-primary-accent rounded-full loading-dot"></div>
                <span class="ml-3 text-lg font-semibold text-primary-accent">Crafting your zero-conflict dialogue...</span>
            </div>
        </div>

        <!-- Results Area -->
        <section id="results-area" class="hidden mt-8 rounded-xl bg-background-dark p-6 shadow-2xl" aria-live="polite" aria-atomic="true">
            <h3 class="text-2xl font-bold text-secondary-accent mb-4">Your Conflict-Free Scripts</h3>
            <div id="script-results" class="space-y-6">
                <!-- Content will be injected here -->
            </div>
        </section>
        
    </div>

    <!-- Modal for Purchase/Messaging -->
    <div id="dialogue-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
        <div class="bg-card-background p-6 lg:p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95 opacity-0" id="modal-content-box">
            
            <h2 id="modal-title" class="text-3xl font-extrabold text-secondary-accent mb-4 text-center">Unlock Scripts</h2>
            <p id="modal-message" class="text-text-light mb-6 text-center">
                Select a script pack below, then **contact the author/support** for a personalized payment link.
                <!-- This message will be updated by JS to include currency (USD or INR) -->
            </p>

            <!-- Pricing Grid -->
            <div id="pricing-grid" class="grid grid-cols-3 gap-3 mb-6">
                
                <!-- 10 Scripts (BASIC) -->
                <label for="basic-pack" id="basic-card" class="pack-card bg-background-dark p-3 rounded-lg text-center relative hover:border-primary-accent selected">
                    <input type="radio" id="basic-pack" name="scriptPack" data-pack-name="BASIC" value="10" checked
                           class="absolute top-2 right-2 h-4 w-4 text-primary-accent bg-transparent border-gray-500 checked:bg-primary-accent focus:ring-0">
                    
                    <h3 class="text-md font-bold text-primary-accent mb-1">BASIC</h3>
                    <p class="text-sm text-text-light mb-1">10 Scripts</p>
                    <p class="text-xl font-extrabold text-white pack-price-display">--</p>
                </label>

                <!-- 50 Scripts (PRO) -->
                <label for="pro-pack" id="pro-card" class="pack-card bg-background-dark p-3 rounded-lg text-center relative hover:border-primary-accent">
                    <input type="radio" id="pro-pack" name="scriptPack" data-pack-name="PRO" value="50"
                           class="absolute top-2 right-2 h-4 w-4 text-primary-accent bg-transparent border-gray-500 checked:bg-primary-accent focus:ring-0">
                    
                    <h3 class="text-md font-bold text-primary-accent mb-1">PRO</h3>
                    <p class="text-sm text-text-light mb-1">50 Scripts</p>
                    <p class="text-xl font-extrabold text-white pack-price-display">--</p>
                </label>

                <!-- 100 Scripts (MAX) -->
                <label for="max-pack" id="max-card" class="pack-card bg-background-dark p-3 rounded-lg text-center relative border-2 border-secondary-accent shadow-lg">
                    <input type="radio" id="max-pack" name="scriptPack" data-pack-name="MAX" value="100"
                           class="absolute top-2 right-2 h-4 w-4 text-secondary-accent bg-transparent border-gray-500 checked:bg-secondary-accent focus:ring-0">
                    
                    <h3 class="text-md font-bold text-secondary-accent mb-1">MAX</h3>
                    <p class="text-sm text-text-light mb-1">100 Scripts</p>
                    <p class="text-xl font-extrabold text-white pack-price-display">--</p>
                </label>
            </div>

            <!-- Contact Instructions -->
            <div id="contact-instructions" class="bg-primary-accent/10 p-4 rounded-lg border border-primary-accent/50 mb-6">
                <p class="text-lg font-semibold text-primary-accent mb-2">Next Step: Get Your Payment Link</p>
                <p class="text-text-light text-sm">
                    Thank you for choosing the **<span id="selected-pack-name" class="font-bold">BASIC</span>** pack (<span id="selected-pack-currency-code">INR</span> <span id="selected-pack-price">199</span>).
                    To complete your purchase, please **email us at <a href="mailto:services@kryptonpath.com" class="font-bold underline text-white hover:text-secondary-accent transition">services@kryptonpath.com</a>** or send a direct message on **Instagram at <a href="https://www.instagram.com/kryptonpath?igsh=MTdtem9jMXd5amluNw%3D%3D&utm_source=qr" target="_blank" class="font-bold underline text-white hover:text-secondary-accent transition">@kryptonpath</a>**. 
                    We will respond promptly with a direct, secure payment link.
                </p>
            </div>

            <button id="buy-scripts-btn" 
                    class="buy-button w-full p-4 text-xl font-bold rounded-lg transition a11y-focus-ring mb-4">
                Proceed to Instagram DM
            </button>
            
            <button id="close-modal-btn" 
                    class="w-full p-3 text-sm text-text-dark hover:text-white transition a11y-focus-ring">
                Go back to designer
            </button>
        </div>
    </div>
    
    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 opacity-0 transform translate-x-10 z-50"></div>


    <script>
        // --- CONFIGURATION ---
        
        // SECURITY RISK WARNING: The API key is exposed in client-side code.
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const INSTAGRAM_URL = "https://www.instagram.com/kryptonpath?igsh=MTdtem9jMXd5amluNw%3D%3D&utm_source=qr";

        // Price Tiers (INR and USD equivalents)
        const PRICING_TIERS = {
            'BASIC': { inr: 199, usd: 2.99 },
            'PRO': { inr: 399, usd: 4.99 },
            'MAX': { inr: 799, usd: 9.99 }
        };

        // State for dynamic currency
        let currentCurrency = {
            code: 'INR', // Default to INR
            symbol: 'â¹',
            priceKey: 'inr'
        };

        // Initial state (Mock credits for a free demo run)
        let mockCredits = 3;

        // Elements
        const form = document.getElementById('dialogue-form');
        const submitBtn = document.getElementById('submit-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsArea = document.getElementById('results-area');
        const scriptResultsDiv = document.getElementById('script-results');
        const creditCounterSpan = document.querySelector('#credit-counter span');
        const modal = document.getElementById('dialogue-modal');
        const modalContentBox = document.getElementById('modal-content-box');
        const buyScriptsBtn = document.getElementById('buy-scripts-btn');
        const buyCreditsLink = document.getElementById('buy-credits-link'); 
        
        const selectedPackName = document.getElementById('selected-pack-name');
        const selectedPackPrice = document.getElementById('selected-pack-price');
        const selectedPackCurrencyCode = document.getElementById('selected-pack-currency-code');


        // --- DYNAMIC CURRENCY LOGIC ---

        function determineCurrencyAndPrices() {
            try {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                // Check if the user is likely in India (Asia/Kolkata or Asia/Calcutta)
                if (timezone.includes('Asia/Kolkata') || timezone.includes('Asia/Calcutta')) {
                    currentCurrency = { code: 'INR', symbol: 'â¹', priceKey: 'inr' };
                    document.getElementById('modal-message').innerHTML = 'Select a script pack below, then **contact the author/support** for a personalized payment link (Prices in **INR**).';
                } else {
                    currentCurrency = { code: 'USD', symbol: '$', priceKey: 'usd' };
                    document.getElementById('modal-message').innerHTML = 'Select a script pack below, then **contact the author/support** for a personalized payment link (Prices in **USD**).';
                }
            } catch (e) {
                // Fallback if Intl is unavailable (shouldn't happen in modern browsers)
                console.warn("Could not determine timezone, defaulting to INR.");
                currentCurrency = { code: 'INR', symbol: 'â¹', priceKey: 'inr' };
                document.getElementById('modal-message').innerHTML = 'Select a script pack below, then **contact the author/support** for a personalized payment link (Prices in **INR**).';
            }


            // Update all card prices based on determined currency
            document.querySelectorAll('input[name="scriptPack"]').forEach(input => {
                const packName = input.dataset.packName;
                const price = PRICING_TIERS[packName][currentCurrency.priceKey];
                
                // Find the associated price display element
                const card = input.closest('.pack-card');
                const priceDisplay = card.querySelector('.pack-price-display');
                
                // Display price without currency symbol, but use symbol for reference in JS state
                priceDisplay.textContent = price;
            });
            
            // Ensure the initial selection is reflected in the message box
            updateSelectedPack(); 
        }

        // --- UI & UX FUNCTIONS ---

        function showNotification(message, type = 'info') {
            const toast = document.getElementById('notification-toast');
            toast.textContent = message;
            
            let bgColor = 'bg-gray-800';
            if (type === 'error') bgColor = 'bg-error-red';
            else if (type === 'success') bgColor = 'bg-success-green';
            else if (type === 'info') bgColor = 'bg-primary-accent';

            toast.className = `fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 transform z-50 ${bgColor}`;
            
            // Show
            toast.classList.remove('opacity-0', 'translate-x-10');
            
            // Hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-10');
            }, 5000);
        }

        function showMessageBox(title, message, isPurchaseFlow = false) {
            document.getElementById('modal-title').textContent = title;
            // The main modal message is set by determineCurrencyAndPrices
            
            if (isPurchaseFlow) {
                // Show contact instructions
                document.getElementById('contact-instructions').classList.remove('hidden');
                
                // Update button text to reflect Instagram action
                buyScriptsBtn.textContent = 'Proceed to Instagram DM';
                buyScriptsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                buyScriptsBtn.disabled = false;
                
                updateSelectedPack();
            } else {
                 document.getElementById('contact-instructions').classList.add('hidden');
                 buyScriptsBtn.disabled = true; 
            }

            modal.classList.remove('hidden');
            // Trigger transition for aesthetics
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContentBox.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal() {
            modalContentBox.classList.add('scale-95', 'opacity-0');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('opacity-100');
            }, 300); // Match transition duration
        }

        function updateCreditUI(count) {
            mockCredits = count;
            creditCounterSpan.textContent = `${count} Script Credits${count > 0 ? '' : ' (RELOAD TO RESET DEMO)'}`;
            
            if (count > 0) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                submitBtn.textContent = 'Generate Scripts (1 Credit)';
            } else {
                submitBtn.disabled = false; // We enable it to trigger the purchase modal
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                submitBtn.textContent = 'Purchase Credits to Generate';
            }
        }

        function updateSelectedPack() {
            const packs = document.querySelectorAll('.pack-card');
            const selectedInput = document.querySelector('input[name="scriptPack"]:checked');
            
            if (!selectedInput) return;

            const name = selectedInput.dataset.packName;
            const price = PRICING_TIERS[name][currentCurrency.priceKey];
            
            selectedPackName.textContent = name;
            selectedPackPrice.textContent = price;
            selectedPackCurrencyCode.textContent = currentCurrency.code;

            packs.forEach(card => {
                const input = card.querySelector('input[name="scriptPack"]');
                if (input.checked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        // --- MOCK PAYMENT LOGIC ---
        
        function handleBuyScripts() {
             // 1. Get selected pack details
            const selectedInput = document.querySelector('input[name="scriptPack"]:checked');
            const name = selectedInput.dataset.pack-name;
            const price = PRICING_TIERS[name][currentCurrency.priceKey];
            const currencyCode = currentCurrency.code;
            
            // 2. Hide the purchase modal
            closeModal();
            
            // 3. Show a professional confirmation toast
            showNotification(
                `Requested ${name} pack (${price} ${currencyCode}). Redirecting you to Instagram to contact support!`, 
                'success'
            );
            
            // 4. Redirect to Instagram after a short delay
            setTimeout(() => {
                window.open(INSTAGRAM_URL, '_blank');
            }, 1000); 
        }
        
        // --- LLM GENERATION LOGIC ---

        async function handleGenerateScripts(event) {
            event.preventDefault();
            
            if (mockCredits <= 0) {
                // IMPORTANT: isPurchaseFlow is TRUE
                showMessageBox(
                    "Unlock Scripts", 
                    "You've used all your **free script credits**. Please choose a script pack below to continue mastering your dialogues.", 
                    true
                );
                return;
            }

            const situationEl = document.getElementById('situation');
            const roleEl = document.getElementById('role');
            const modeEl = document.getElementById('mode');
            
            if (!situationEl.value || !roleEl.value || !modeEl.value || !document.getElementById('context').value) {
                showMessageBox("Missing Information", "Please fill all fields to generate scripts.", false);
                return;
            }

            // Start loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            loadingIndicator.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            
            const formData = new FormData(form);
            const situation = formData.get('situation');
            const role = formData.get('role');
            const mode = formData.get('mode');
            const context = formData.get('context');

            const systemPrompt = `You are the KryptonPath Dialogue Designer, a world-class communication AI. Your task is to generate three distinct, conflict-free professional dialogue scripts based on the user's input. The response MUST be in Markdown format, with three clearly separated scripts under H2 headings (##).

1.  **Direct Script (Action-Oriented):** Focus on clarity, boundaries, and immediate resolution.
2.  **Empathetic Script (Relationship-Focused):** Focus on understanding, shared goals, and collaborative problem-solving.
3.  **Formal Script (Documentation-Ready):** Focus on professional language, objective facts, and formal documentation (e.g., an email or official verbal statement).

Ensure all scripts are professional, respectful, and achieve the user's objective without escalating conflict. Use placeholders like [Manager's Name] or [Specific Date].`;

            const userQuery = `SITUATION: ${situation}\nROLE: ${role}\nMODE: ${mode}\nCONTEXT: ${context}`;

            // Implement exponential backoff for API call
            const maxRetries = 3;
            let attempt = 0;
            let success = false;
            let text = null;

            while (attempt < maxRetries && !success) {
                attempt++;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Attempt ${attempt}: API failed with status ${response.status}. Body: ${errorText}`);
                        throw new Error(`API failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        success = true;
                    } else {
                        throw new Error("Received empty or malformed response from AI.");
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt} error:`, error.message);
                    if (attempt < maxRetries) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Throw the final error to be caught by the outer try/catch
                        throw error;
                    }
                }
            }


            try {
                // Decrement credit (MOCK LOGIC) only if API succeeded
                if(success) {
                    updateCreditUI(mockCredits - 1);
                    displayResults(text);
                    showNotification(`Script generated! ${mockCredits - 1} credits remaining.`, 'success');
                } else {
                    // This should ideally not be reached if the final error is thrown above,
                    // but exists as a safeguard.
                    throw new Error("Failed to generate content after maximum retries.");
                }

            } catch (error) {
                console.error("Final Script generation error caught:", error);
                showNotification('Generation failed. Please try again or check the console for API errors.', 'error');
            } finally {
                // IMPORTANT: This runs regardless of success or failure, resetting the UI
                loadingIndicator.classList.add('hidden');
                // Re-enable button state (mockCredits will be updated if success was true)
                updateCreditUI(mockCredits); 
            }
        }

        function displayResults(markdownText) {
            // Simple Markdown-to-HTML conversion for the three main sections
            scriptResultsDiv.innerHTML = '';
            
            // Split by H2 marker
            const sections = markdownText.split('##').filter(s => s.trim() !== '');

            sections.forEach(section => {
                const lines = section.trim().split('\n');
                const title = lines[0].trim();
                const content = lines.slice(1).join('\n').trim().replace(/\n/g, '<br>');

                const card = document.createElement('div');
                card.className = 'bg-card-background p-5 rounded-lg border-l-4 border-primary-accent shadow-md';
                card.innerHTML = `
                    <h4 class="text-xl font-semibold text-text-light mb-2">${title}</h4>
                    <p class="text-text-dark text-sm leading-relaxed">${content}</p>
                `;
                scriptResultsDiv.appendChild(card);
            });

            resultsArea.classList.remove('hidden');
            resultsArea.scrollIntoView({ behavior: 'smooth' });
        }
        
        // --- EVENT LISTENERS & INITIALIZATION ---

        window.onload = () => {
             // Initialize UI state
            updateCreditUI(3); 
            
            // 1. Determine local currency and update all prices
            determineCurrencyAndPrices(); 

            // 2. Set default selection
            document.getElementById('basic-pack').checked = true;
            
            // 3. Update the modal message box based on the default selection
            updateSelectedPack(); 
        };

        form.addEventListener('submit', handleGenerateScripts);
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);
        buyScriptsBtn.addEventListener('click', handleBuyScripts);
        
        // Listener for the always-visible Buy Credits button
        buyCreditsLink.addEventListener('click', () => {
            showMessageBox(
                "KryptonPath Script Packs", 
                "Select a script pack below to expand your dialogue toolkit and contact us for a payment link.", 
                true // isPurchaseFlow = true
            );
        });

        // Modal radio button change listener
        document.querySelectorAll('input[name="scriptPack"]').forEach(input => {
            input.addEventListener('change', updateSelectedPack);
        });

    </script>
</body>
</html>

