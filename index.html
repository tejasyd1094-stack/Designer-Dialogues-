<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KryptonPath Dialogue Designer - Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Montserrat:wght=400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for aesthetic, modern, and vibrant design */
        :root {
            --primary-accent: #6C63FF; /* Vibrant Purple/Indigo */
            --secondary-accent: #FFD233; /* Bright Yellow/Gold */
            --background-dark: #1A1A2E; /* Deep Navy Blue */
            --card-background: #1F2840; /* Slightly lighter navy for cards */
            --text-light: #E0E0E0; /* Off-white for readability */
            --text-dark: #AAAAAA; /* Lighter grey for secondary text */
            --success-green: #3DDC84; /* Vibrant Green for success */
            --error-red: #FF6B6B; /* Soft Red for errors */
            --warning-orange: #FF8C00; /* For fallback state */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, #151927 100%);
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 0;
        }
        .a11y-focus-ring:focus {
            outline: 3px solid var(--secondary-accent);
            outline-offset: 2px;
        }
        .container-card {
            background-color: var(--card-background);
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.5);
        }
        .input-style, .select-style {
            background-color: #374151; /* Darker input background */
            border: 2px solid #4b5563;
            color: var(--text-light);
            transition: border-color 0.3s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23AAAAAA'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        .input-style:focus, .select-style:focus {
            border-color: var(--primary-accent);
        }
        .button-primary {
            background-color: var(--primary-accent);
            transition: background-color 0.3s, transform 0.1s;
        }
        .button-primary:hover:not(:disabled) {
            background-color: #5d53ee;
            transform: translateY(-1px);
        }
        .loading-dot {
            animation: bounce 0.6s infinite alternate;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            to {
                opacity: 0.5;
                transform: translateY(-8px);
            }
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
        .pack-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .pack-card:hover {
            border-color: var(--primary-accent);
        }
        .pack-card.selected {
            border-color: var(--secondary-accent);
            background-color: rgba(255, 210, 51, 0.1);
            transform: scale(1.03);
        }
        .buy-button {
            background-color: var(--success-green);
            color: #1A1A2E;
        }
        .buy-button:hover {
            background-color: #2da468;
        }
        .fallback-message {
            background-color: var(--warning-orange);
            color: #1A1A2E;
            font-weight: 600;
        }
    </style>
</head>
<body class="selection:bg-primary-accent selection:text-white">

    <div class="max-w-xl w-full p-4 lg:p-8 container-card rounded-3xl">

        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-white mb-2 tracking-tight">KryptonPath Dialogue Designer</h1>
            <h2 class="text-xl font-semibold text-primary-accent mb-4">The Zero-Conflict Corporate Dialogue Engine.</h2>
            <p class="text-lg text-text-dark max-w-md mx-auto">
                Instantly curate 3 professional, conflict-free scripts for any high-stakes work conversation.
            </p>
            <div id="credit-counter" class="inline-block mt-4 p-2 px-4 rounded-full bg-primary-accent shadow-lg">
                <span class="text-lg font-bold text-secondary-accent">3 Script Credits (Demo)</span>
            </div>
            <!-- Button to always show purchase options -->
            <button id="buy-credits-link" class="mt-4 block mx-auto text-sm font-semibold text-white bg-[#374151] hover:bg-[#4b5563] px-6 py-2 rounded-full transition a11y-focus-ring">
                View Plans & Buy Scripts
            </button>
            
        </header>

        <!-- Form for input -->
        <form id="dialogue-form" class="space-y-6">
            
            <!-- 1. Situation Dropdown -->
            <div>
                <label for="situation" class="block text-sm font-medium mb-2 text-text-light">1. Select the corporate pain point (Situation):</label>
                <select id="situation" name="situation" required
                        class="select-style w-full p-3 rounded-lg a11y-focus-ring">
                    <option value="" disabled selected>Choose a common workplace challenge</option>
                    <option value="Handling unjustified criticism from a senior leader.">Handling unjustified criticism from a senior leader.</option>
                    <option value="Addressing a colleague who consistently misses deadlines.">Addressing a colleague who consistently misses deadlines.</option>
                    <option value="Negotiating a better salary/compensation package.">Negotiating a better salary/compensation package.</option>
                    <option value="Giving difficult performance feedback to a direct report.">Giving difficult performance feedback to a direct report.</option>
                    <option value="Pushing back against an overwhelming new project assignment.">Pushing back against an overwhelming new project assignment.</option>
                </select>
            </div>

            <!-- 2. Role Dropdown -->
            <div>
                <label for="role" class="block text-sm font-medium mb-2 text-text-light">2. What is your role in this conversation?</label>
                <select id="role" name="role" required
                        class="select-style w-full p-3 rounded-lg a11y-focus-ring">
                    <option value="" disabled selected>Identify your role and audience</option>
                    <option value="Manager speaking to Direct Report.">Manager speaking to Direct Report.</option>
                    <option value="Direct Report speaking to Manager.">Direct Report speaking to Manager.</option>
                    <option value="Colleague speaking to Peer/Teammate.">Colleague speaking to Peer/Teammate.</option>
                </select>
            </div>

            <!-- 3. Mode Dropdown -->
            <div>
                <label for="mode" class="block text-sm font-medium mb-2 text-text-light">3. What is the communication mode?</label>
                <select id="mode" name="mode" required
                        class="select-style w-full p-3 rounded-lg a11y-focus-ring">
                    <option value="" disabled selected>How will you deliver the message?</option>
                    <option value="Verbal Conversation (In-person or Video Call).">Verbal Conversation (In-person or Video Call).</option>
                    <option value="Written Communication (Email/Memo).">Written Communication (Email/Memo).</option>
                    <option value="Instant Message (Slack/Teams).">Instant Message (Slack/Teams).</option>
                </select>
            </div>

            <!-- Context Input (Remains text area for specificity) -->
            <div>
                <label for="context" class="block text-sm font-medium mb-2 text-text-light">4. Provide brief context (What specifically happened?):</label>
                <textarea id="context" name="context" rows="4" placeholder="Example: My manager frequently interrupts me during project updates, making me feel unheard and losing momentum on the topic." required
                          class="input-style w-full p-3 rounded-lg a11y-focus-ring resize-none"></textarea>
                <p class="text-xs text-text-dark mt-1">
                    Be specific about the last incident for the best three-script outcome.
                </p>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submit-btn" 
                    class="button-primary w-full p-4 text-xl font-bold rounded-lg a11y-focus-ring"
                    aria-live="polite">
                Generate Scripts (1 Credit)
            </button>
        </form>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center mt-8 p-4" role="status" aria-label="Generating scripts, please wait.">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-3 h-3 bg-primary-accent rounded-full loading-dot"></div>
                <div class="w-3 h-3 bg-primary-accent rounded-full loading-dot"></div>
                <div class="w-3 h-3 bg-primary-accent rounded-full loading-dot"></div>
                <span class="ml-3 text-lg font-semibold text-primary-accent">Crafting your zero-conflict dialogue...</span>
            </div>
        </div>

        <!-- Results Area -->
        <section id="results-area" class="hidden mt-8 rounded-xl bg-background-dark p-6 shadow-2xl" aria-live="polite" aria-atomic="true">
             <div id="fallback-alert" class="hidden p-4 rounded-lg mb-6 fallback-message">
                <p class="text-sm">
                    <strong>â ï¸ Fallback Scripts Used:</strong> The AI generation service is currently experiencing high load (API limit reached). We provided high-quality, pre-written examples based on your topic. Try again later for truly personalized scripts.
                </p>
            </div>
            <h3 class="text-2xl font-bold text-secondary-accent mb-4">Your Conflict-Free Scripts</h3>
            <div id="script-results" class="space-y-6">
                <!-- Content will be injected here -->
            </div>
        </section>
        
    </div>

    <!-- Modal for Purchase/Messaging -->
    <div id="dialogue-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
        <div class="bg-card-background p-6 lg:p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95 opacity-0" id="modal-content-box">
            
            <h2 id="modal-title" class="text-3xl font-extrabold text-secondary-accent mb-4 text-center">Unlock Scripts</h2>
            <p id="modal-message" class="text-text-light mb-6 text-center">
                Select a script pack below, then **contact the author/support** for a personalized payment link.
                <!-- This message will be updated by JS to include currency (USD or INR) -->
            </p>

            <!-- Pricing Grid -->
            <div id="pricing-grid" class="grid grid-cols-3 gap-3 mb-6">
                
                <!-- 10 Scripts (BASIC) -->
                <label for="basic-pack" id="basic-card" class="pack-card bg-background-dark p-3 rounded-lg text-center relative hover:border-primary-accent selected">
                    <input type="radio" id="basic-pack" name="scriptPack" data-pack-name="BASIC" value="10" checked
                           class="absolute top-2 right-2 h-4 w-4 text-primary-accent bg-transparent border-gray-500 checked:bg-primary-accent focus:ring-0">
                    
                    <h3 class="text-md font-bold text-primary-accent mb-1">BASIC</h3>
                    <p class="text-sm text-text-light mb-1">10 Scripts</p>
                    <p class="text-xl font-extrabold text-white pack-price-display">--</p>
                </label>

                <!-- 50 Scripts (PRO) -->
                <label for="pro-pack" id="pro-card" class="pack-card bg-background-dark p-3 rounded-lg text-center relative hover:border-primary-accent">
                    <input type="radio" id="pro-pack" name="scriptPack" data-pack-name="PRO" value="50"
                           class="absolute top-2 right-2 h-4 w-4 text-primary-accent bg-transparent border-gray-500 checked:bg-primary-accent focus:ring-0">
                    
                    <h3 class="text-md font-bold text-primary-accent mb-1">PRO</h3>
                    <p class="text-sm text-text-light mb-1">50 Scripts</p>
                    <p class="text-xl font-extrabold text-white pack-price-display">--</p>
                </label>

                <!-- 100 Scripts (MAX) -->
                <label for="max-pack" id="max-card" class="pack-card bg-background-dark p-3 rounded-lg text-center relative border-2 border-secondary-accent shadow-lg">
                    <input type="radio" id="max-pack" name="scriptPack" data-pack-name="MAX" value="100"
                           class="absolute top-2 right-2 h-4 w-4 text-secondary-accent bg-transparent border-gray-500 checked:bg-secondary-accent focus:ring-0">
                    
                    <h3 class="text-md font-bold text-secondary-accent mb-1">MAX</h3>
                    <p class="text-sm text-text-light mb-1">100 Scripts</p>
                    <p class="text-xl font-extrabold text-white pack-price-display">--</p>
                </label>
            </div>

            <!-- Contact Instructions -->
            <div id="contact-instructions" class="bg-primary-accent/10 p-4 rounded-lg border border-primary-accent/50 mb-6">
                <p class="text-lg font-semibold text-primary-accent mb-2">Next Step: Get Your Payment Link</p>
                <p class="text-text-light text-sm">
                    Thank you for choosing the **<span id="selected-pack-name" class="font-bold">BASIC</span>** pack (<span id="selected-pack-currency-code">INR</span> <span id="selected-pack-price">199</span>).
                    To complete your purchase, please **email us at <a href="mailto:services@kryptonpath.com" class="font-bold underline text-white hover:text-secondary-accent transition">services@kryptonpath.com</a>** or send a direct message on **Instagram at <a href="https://www.instagram.com/kryptonpath?igsh=MTdtem9jMXd5amluNw%3D%3D&utm_source=qr" target="_blank" class="font-bold underline text-white hover:text-secondary-accent transition">@kryptonpath</a>**. 
                    We will respond promptly with a direct, secure payment link.
                </p>
            </div>

            <button id="buy-scripts-btn" 
                    class="buy-button w-full p-4 text-xl font-bold rounded-lg transition a11y-focus-ring mb-4">
                Proceed to Instagram DM
            </button>
            
            <button id="close-modal-btn" 
                    class="w-full p-3 text-sm text-text-dark hover:text-white transition a11y-focus-ring">
                Go back to designer
            </button>
        </div>
    </div>
    
    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 opacity-0 transform translate-x-10 z-50"></div>


    <script>
        // --- CONFIGURATION ---
        
        // SECURITY RISK WARNING: The API key is exposed in client-side code.
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const INSTAGRAM_URL = "https://www.instagram.com/kryptonpath?igsh=MTdtem9jMXd5amluNw%3D%3D&utm_source=qr";

        // Price Tiers (INR and USD equivalents)
        const PRICING_TIERS = {
            'BASIC': { inr: 199, usd: 2.99 },
            'PRO': { inr: 399, usd: 4.99 },
            'MAX': { inr: 799, usd: 9.99 }
        };

        // State for dynamic currency
        let currentCurrency = {
            code: 'INR', // Default to INR
            symbol: 'â¹',
            priceKey: 'inr'
        };

        // Initial state (Mock credits for a free demo run)
        let mockCredits = 3;

        // Elements
        const form = document.getElementById('dialogue-form');
        const submitBtn = document.getElementById('submit-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsArea = document.getElementById('results-area');
        const scriptResultsDiv = document.getElementById('script-results');
        const fallbackAlert = document.getElementById('fallback-alert');
        const creditCounterSpan = document.querySelector('#credit-counter span');
        const modal = document.getElementById('dialogue-modal');
        const modalContentBox = document.getElementById('modal-content-box');
        const buyScriptsBtn = document.getElementById('buy-scripts-btn');
        const buyCreditsLink = document.getElementById('buy-credits-link'); 
        
        const selectedPackName = document.getElementById('selected-pack-name');
        const selectedPackPrice = document.getElementById('selected-pack-price');
        const selectedPackCurrencyCode = document.getElementById('selected-pack-currency-code');

        // --- FALLBACK SCRIPT DATA ---
        const FALLBACK_SCRIPTS = {
            // Default scripts for when the specific situation is unknown or API fails
            default: "## Direct Script (Action-Oriented)\n[Your Name]: \"[Colleague Name], I need to talk about the project status. I've noticed you've missed the last two internal deadlines, which is impacting the next phase. What's currently blocking you from hitting the agreed-upon targets? We need a clear, realistic plan for the next 48 hours.\"\n\n## Empathetic Script (Relationship-Focused)\n[Your Name]: \"[Colleague Name], I know you've been managing a lot lately. I want to check in on the project. When team deliverables slip, it affects all of us. Can we look at your current workload together right now? My goal is to support you and ensure we hit the final milestone as a team.\"\n\n## Formal Script (Documentation-Ready)\nSubject: Urgent: Project [X] Deliverable Status Review\n\n[Your Name]: \"Hi [Colleague Name], As of [Date], the deliverable for Phase B is overdue. This critical path item is now delaying the start of Phase C. Please provide an immediate update on the reason for the delay and a firm, confirmed timeline for completion by end-of-day [Today's Date]. I need assurance that we can meet our external commitments.\"",
            
            // Scripts for: Handling unjustified criticism from a senior leader.
            "Handling unjustified criticism from a senior leader.": "## Direct Script (Action-Oriented)\n[Your Name]: \"Thank you for that feedback, [Leader's Name]. To ensure I understand, could you specify which data point or deliverable led to that conclusion? I'd like to reference the initial project brief so we can be sure we're aligned on the scope.\"\n\n## Empathetic Script (Relationship-Focused)\n[Your Name]: \"I appreciate you raising this, [Leader's Name]. It sounds like there's a disconnect between what I'm delivering and what you expect from this role. Before we delve into next steps, could you walk me through your key priorities for this quarter so I can recalibrate my focus?\"\n\n## Formal Script (Documentation-Ready)\n[Your Name]: \"[Leader's Name], I acknowledge your comment about [Specific Criticism]. I will document this conversation and follow up with an email outlining the metrics and results delivered to date, along with my understanding of your suggested pivot. I want to ensure we have a clear, agreed-upon record for the project file.\"",

            // Scripts for: Addressing a colleague who consistently misses deadlines.
            "Addressing a colleague who consistently misses deadlines.": "## Direct Script (Action-Oriented)\n[Your Name]: \"[Colleague Name], the deadline for the Q3 report was yesterday. Missing these internal checkpoints is now impacting my ability to finalize the presentation. What is the guaranteed, non-negotiable time you will have this to me today? I need a clear commitment.\"\n\n## Empathetic Script (Relationship-Focused)\n[Your Name]: \"I know you're juggling a lot, [Colleague Name], but I'm getting worried about our shared timeline. When you miss your deadline, my whole schedule slides. Is there anything on your plate I can take over, or something I can do to help you prioritize this so we can move forward together?\"\n\n## Formal Script (Documentation-Ready)\n[Your Name]: \"Hi [Colleague Name], Following up on the deliverable due [Date]. This is now [X] days past due. Per our Project Charter, this item is critical. Please respond to this message immediately with your updated completion time and provide a brief explanation for the delay, so I can update the project manager.\"",
            
            // Scripts for: Negotiating a better salary/compensation package.
            "Negotiating a better salary/compensation package.": "## Direct Script (Action-Oriented)\n[Your Name]: \"Based on my contributionsâspecifically generating [X] revenue and taking on the [Y] responsibilityâand market data that places my current role salary range at [Higher Range], I am formally requesting a salary adjustment to [Target Amount]. I believe this accurately reflects the value I bring to the team.\"\n\n## Empathetic Script (Relationship-Focused)\n[Your Name]: \"I'm committed to [Company Name] and excited about my future here. As I've grown, I've taken on [List new responsibilities]. Could we discuss my compensation? I want to make sure my salary is competitive and reflects my increased value and dedication to the team's success.\"\n\n## Formal Script (Documentation-Ready)\n[Your Name]: \"[Manager's Name], I request a formal review of my current total compensation package. In the last year, I have consistently exceeded expectations in [Key Area 1] and successfully led [Project Name]. I have attached a document detailing my achievements and market research to support a compensation adjustment.\"",

            // Scripts for: Giving difficult performance feedback to a direct report.
            "Giving difficult performance feedback to a direct report.": "## Direct Script (Action-Oriented)\n[Your Name]: \"[Report's Name], we need to talk about your task completion rate. Last week, three critical assignments were delivered late, which has created rework for the team. My expectation is that all assigned tasks are completed on time, or you communicate a delay 24 hours in advance. Can you commit to that standard moving forward?\"\n\n## Empathetic Script (Relationship-Focused)\n[Your Name]: \"I care about your success here, [Report's Name], and I've noticed a pattern lately where [Specific Behavior, e.g., you seem disengaged in meetings]. Let's discuss what's going on and what support you need from me. We need to get you back on track to meet your goals.\"\n\n## Formal Script (Documentation-Ready)\n[Your Name]: \"[Report's Name], this meeting is to formally document performance concerns related to punctuality and adherence to operational standards, specifically regarding [Incident Date]. We will implement a 30-day performance improvement plan, with mandatory weekly check-ins to monitor progress against agreed-upon metrics.\"",
            
            // Scripts for: Pushing back against an overwhelming new project assignment.
            "Pushing back against an overwhelming new project assignment.": "## Direct Script (Action-Oriented)\n[Your Name]: \"I see the value of this new project, but based on my current loadâProject X (40 hours) and Project Y (30 hours)âI cannot take on Z without compromising quality on the other two. Which of the three projects should I de-prioritize to dedicate the necessary time to Z?\"\n\n## Empathetic Script (Relationship-Focused)\n[Your Name]: \"I'm excited about the opportunity with Project Z. I know it's important. However, I want to deliver quality work. Before I start, can we review my existing schedule to find a realistic resource allocation? I want to partner with you to make sure we're setting up all projects for success.\"\n\n## Formal Script (Documentation-Ready)\n[Your Name]: \"[Manager's Name], I am submitting a formal resource reallocation request concerning Project Z. My current capacity is fully allocated to Projects X and Y until [Date]. I recommend either deferring Project Z until then, or assigning Project X to [Colleague Name] to ensure Project Z can receive the dedicated attention required.\""
        };


        // --- DYNAMIC CURRENCY LOGIC ---

        function determineCurrencyAndPrices() {
            try {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                // Check if the user is likely in India (Asia/Kolkata or Asia/Calcutta)
                if (timezone.includes('Asia/Kolkata') || timezone.includes('Asia/Calcutta')) {
                    currentCurrency = { code: 'INR', symbol: 'â¹', priceKey: 'inr' };
                    document.getElementById('modal-message').innerHTML = 'Select a script pack below, then **contact the author/support** for a personalized payment link (Prices in **INR**).';
                } else {
                    currentCurrency = { code: 'USD', symbol: '$', priceKey: 'usd' };
                    document.getElementById('modal-message').innerHTML = 'Select a script pack below, then **contact the author/support** for a personalized payment link (Prices in **USD**).';
                }
            } catch (e) {
                // Fallback if Intl is unavailable (shouldn't happen in modern browsers)
                console.warn("Could not determine timezone, defaulting to INR.");
                currentCurrency = { code: 'INR', symbol: 'â¹', priceKey: 'inr' };
                document.getElementById('modal-message').innerHTML = 'Select a script pack below, then **contact the author/support** for a personalized payment link (Prices in **INR**).';
            }


            // Update all card prices based on determined currency
            document.querySelectorAll('input[name="scriptPack"]').forEach(input => {
                const packName = input.dataset.packName;
                const price = PRICING_TIERS[packName][currentCurrency.priceKey];
                
                // Find the associated price display element
                const card = input.closest('.pack-card');
                const priceDisplay = card.querySelector('.pack-price-display');
                
                // Display price without currency symbol, but use symbol for reference in JS state
                priceDisplay.textContent = price;
            });
            
            // Ensure the initial selection is reflected in the message box
            updateSelectedPack(); 
        }

        // --- UI & UX FUNCTIONS ---

        function showNotification(message, type = 'info') {
            const toast = document.getElementById('notification-toast');
            toast.textContent = message;
            
            let bgColor = 'bg-gray-800';
            if (type === 'error') bgColor = 'bg-error-red';
            else if (type === 'success') bgColor = 'bg-success-green';
            else if (type === 'info') bgColor = 'bg-primary-accent';

            toast.className = `fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 transform z-50 ${bgColor}`;
            
            // Show
            toast.classList.remove('opacity-0', 'translate-x-10');
            
            // Hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-10');
            }, 5000);
        }

        function showMessageBox(title, message, isPurchaseFlow = false) {
            document.getElementById('modal-title').textContent = title;
            // The main modal message is set by determineCurrencyAndPrices
            
            if (isPurchaseFlow) {
                // Show contact instructions
                document.getElementById('contact-instructions').classList.remove('hidden');
                
                // Update button text to reflect Instagram action
                buyScriptsBtn.textContent = 'Proceed to Instagram DM';
                buyScriptsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                buyScriptsBtn.disabled = false;
                
                updateSelectedPack();
            } else {
                 document.getElementById('contact-instructions').classList.add('hidden');
                 buyScriptsBtn.disabled = true; 
            }

            modal.classList.remove('hidden');
            // Trigger transition for aesthetics
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContentBox.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal() {
            modalContentBox.classList.add('scale-95', 'opacity-0');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('opacity-100');
            }, 300); // Match transition duration
        }

        function updateCreditUI(count) {
            mockCredits = count;
            creditCounterSpan.textContent = `${count} Script Credits${count > 0 ? '' : ' (RELOAD TO RESET DEMO)'}`;
            
            if (count > 0) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                submitBtn.textContent = 'Generate Scripts (1 Credit)';
            } else {
                submitBtn.disabled = false; // We enable it to trigger the purchase modal
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                submitBtn.textContent = 'Purchase Credits to Generate';
            }
        }

        function updateSelectedPack() {
            const packs = document.querySelectorAll('.pack-card');
            const selectedInput = document.querySelector('input[name="scriptPack"]:checked');
            
            if (!selectedInput) return;

            const name = selectedInput.dataset.packName;
            const price = PRICING_TIERS[name][currentCurrency.priceKey];
            
            selectedPackName.textContent = name;
            selectedPackPrice.textContent = price;
            selectedPackCurrencyCode.textContent = currentCurrency.code;

            packs.forEach(card => {
                const input = card.querySelector('input[name="scriptPack"]');
                if (input.checked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        // --- MOCK PAYMENT LOGIC ---
        
        function handleBuyScripts() {
             // 1. Get selected pack details
            const selectedInput = document.querySelector('input[name="scriptPack"]:checked');
            const name = selectedInput.dataset.packName;
            const price = PRICING_TIERS[name][currentCurrency.priceKey];
            const currencyCode = currentCurrency.code;
            
            // 2. Hide the purchase modal
            closeModal();
            
            // 3. Show a professional confirmation toast
            showNotification(
                `Requested ${name} pack (${price} ${currencyCode}). Redirecting you to Instagram to contact support!`, 
                'success'
            );
            
            // 4. Redirect to Instagram after a short delay
            setTimeout(() => {
                window.open(INSTAGRAM_URL, '_blank');
            }, 1000); 
        }
        
        // --- LLM GENERATION LOGIC (Simplified for reliability) ---

        async function handleGenerateScripts(event) {
            event.preventDefault();
            
            if (mockCredits <= 0) {
                showMessageBox(
                    "Unlock Scripts", 
                    "You've used all your **free script credits**. Please choose a script pack below to continue mastering your dialogues.", 
                    true
                );
                return;
            }

            const situationEl = document.getElementById('situation');
            const roleEl = document.getElementById('role');
            const modeEl = document.getElementById('mode');
            
            if (!situationEl.value || !roleEl.value || !modeEl.value || !document.getElementById('context').value) {
                showMessageBox("Missing Information", "Please fill all fields to generate scripts.", false);
                return;
            }

            // Start loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            loadingIndicator.classList.remove('hidden');
            resultsArea.classList.add('hidden');
            fallbackAlert.classList.add('hidden'); // Hide fallback alert initially
            
            const formData = new FormData(form);
            const situation = formData.get('situation');
            const role = formData.get('role');
            const mode = formData.get('mode');
            const context = formData.get('context');

            const systemPrompt = `You are the KryptonPath Dialogue Designer, a world-class communication AI. Your task is to generate three distinct, conflict-free professional dialogue scripts based on the user's input. The response MUST be in Markdown format, with three clearly separated scripts under H2 headings (##).

1.  **Direct Script (Action-Oriented):** Focus on clarity, boundaries, and immediate resolution.
2.  **Empathetic Script (Relationship-Focused):** Focus on understanding, shared goals, and collaborative problem-solving.
3.  **Formal Script (Documentation-Ready):** Focus on professional language, objective facts, and formal documentation (e.g., an email or official verbal statement).

Ensure all scripts are professional, respectful, and achieve the user's objective without escalating conflict. Use placeholders like [Manager's Name] or [Specific Date].`;

            const userQuery = `SITUATION: ${situation}\nROLE: ${role}\nMODE: ${mode}\nCONTEXT: ${context}`;

            let success = false;
            let generatedText = null;

            try {
                // Single, direct API call
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (generatedText && generatedText.trim()) {
                        success = true;
                    } else {
                        throw new Error("AI returned empty or invalid content.");
                    }
                } else {
                    const errorDetails = await response.text();
                    console.error("API Fetch Error Status:", response.status, "Details:", errorDetails);
                    throw new Error(`API call failed with status ${response.status}.`);
                }

            } catch (error) {
                // --- FALLBACK MODE ACTIVATED ---
                console.warn("API failed. Falling back to local scripts.", error.message);
                
                // Get pre-written script based on selection, or use default if needed
                generatedText = FALLBACK_SCRIPTS[situation] || FALLBACK_SCRIPTS.default;
                
                // Display the fallback alert
                fallbackAlert.classList.remove('hidden');
                
                // Note: We count this as a successful user experience even though it's a fallback.
                success = true; 
            }


            try {
                if (success) {
                    // Decrement credit only if the API call was successful AND NOT a fallback
                    if (!fallbackAlert.classList.contains('hidden')) {
                        // Fallback used. Do not decrement credit to encourage user to try personalized service later.
                        showNotification('Fallback used. Credit NOT deducted.', 'info');
                    } else {
                        // API Success: Decrement credit
                        updateCreditUI(mockCredits - 1);
                        showNotification(`Script generated! ${mockCredits - 1} credits remaining.`, 'success');
                    }
                    
                    displayResults(generatedText);
                    
                } else {
                    // Critical failure even the fallback failed (shouldn't happen)
                    showNotification('A critical error occurred. Please refresh the page.', 'error');
                }

            } catch (error) {
                console.error("Script rendering or finalization failed:", error);
                showNotification('An error occurred while displaying results.', 'error');
            } finally {
                // Always reset UI elements
                loadingIndicator.classList.add('hidden');
                updateCreditUI(mockCredits); // Resets button state based on mockCredits
            }
        }

        function displayResults(markdownText) {
            // Simple Markdown-to-HTML conversion for the three main sections
            scriptResultsDiv.innerHTML = '';
            
            // Split by H2 marker
            const sections = markdownText.split('##').filter(s => s.trim() !== '');

            sections.forEach(section => {
                const lines = section.trim().split('\n');
                const title = lines[0].trim();
                const content = lines.slice(1).join('\n').trim().replace(/\n/g, '<br>');

                const card = document.createElement('div');
                card.className = 'bg-card-background p-5 rounded-lg border-l-4 border-primary-accent shadow-md';
                card.innerHTML = `
                    <h4 class="text-xl font-semibold text-text-light mb-2">${title}</h4>
                    <p class="text-text-dark text-sm leading-relaxed">${content}</p>
                `;
                scriptResultsDiv.appendChild(card);
            });

            resultsArea.classList.remove('hidden');
            resultsArea.scrollIntoView({ behavior: 'smooth' });
        }
        
        // --- EVENT LISTENERS & INITIALIZATION ---

        window.onload = () => {
             // Initialize UI state
            updateCreditUI(3); 
            
            // 1. Determine local currency and update all prices
            determineCurrencyAndPrices(); 

            // 2. Set default selection
            document.getElementById('basic-pack').checked = true;
            
            // 3. Update the modal message box based on the default selection
            updateSelectedPack(); 
        };

        form.addEventListener('submit', handleGenerateScripts);
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);
        buyScriptsBtn.addEventListener('click', handleBuyScripts);
        
        // Listener for the always-visible Buy Credits button
        buyCreditsLink.addEventListener('click', () => {
            showMessageBox(
                "KryptonPath Script Packs", 
                "Select a script pack below to expand your dialogue toolkit and contact us for a payment link.", 
                true // isPurchaseFlow = true
            );
        });

        // Modal radio button change listener
        document.querySelectorAll('input[name="scriptPack"]').forEach(input => {
            input.addEventListener('change', updateSelectedPack);
        });

    </script>
</body>
</html>

